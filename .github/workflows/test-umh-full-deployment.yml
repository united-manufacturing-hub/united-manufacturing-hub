name: Test UMH Full Deployment

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  data-flow-test:
    name: Data Flow Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Prepare k3d cluster
        id: prepare-k3d
        uses: AbsaOSS/k3d-action@v2
        with:
          cluster-name: "umh-full"
          args: --agents 1 --image rancher/k3s:v1.24.4-k3s1
      - name: Install UMH
        id: install-umh
        run: |
          kubectl create ns united-manufacturing-hub
          helm install united-manufacturing-hub ./deployment/united-manufacturing-hub -f ./test/test-values-full.yaml -n united-manufacturing-hub --wait --timeout 7m --debug
          kubectl get po,svc -n united-manufacturing-hub
      - name: Debug Install UMH failure
        id: debug-install-umh-failure
        if: ${{ failure() && steps.install-umh.outcome == 'failure' }}
        run: |
          mkdir -p ./install-umh-step
          kubectl logs deployment/united-manufacturing-hub-opcuasimulator-deployment -n united-manufacturing-hub --all-containers --prefix > ./install-umh-step/deployment-opcuasimulator.log 2> /dev/null
          kubectl logs deployment/united-manufacturing-hub-factoryinsight-deployment -n united-manufacturing-hub --all-containers --prefix > ./install-umh-step/deployment-factoryinsight.log 2> /dev/null
          kubectl logs deployment/united-manufacturing-hub-grafanaproxy -n united-manufacturing-hub --all-containers --prefix > ./install-umh-step/deployment-grafanaproxy.log 2> /dev/null
          kubectl logs deployment/united-manufacturing-hub-iotsensorsmqtt -n united-manufacturing-hub --all-containers --prefix > ./install-umh-step/deployment-iotsensormqtt.log 2> /dev/null
          kubectl logs deployment/united-manufacturing-hub-grafana -n united-manufacturing-hub --all-containers --prefix > ./install-umh-step/deployment-grafana.log 2> /dev/null
          kubectl logs deployment/united-manufacturing-hub-kafkatopostgresql -n united-manufacturing-hub --all-containers --prefix > ./install-umh-step/deployment-kafkatopostgresql.log 2> /dev/null
          kubectl logs deployment/united-manufacturing-hub-mqttkafkabridge -n united-manufacturing-hub --all-containers --prefix > ./install-umh-step/deployment-mqttkafkabridge.log 2> /dev/null
          kubectl logs deployment/united-manufacturing-hub-console -n united-manufacturing-hub --all-containers --prefix > ./install-umh-step/deployment-console.log 2> /dev/null
          kubectl logs deployment/united-manufacturing-hub-packmlmqttsimulator -n united-manufacturing-hub --all-containers --prefix > ./install-umh-step/deployment-packmlmqttsimulator.log 2> /dev/null
          kubectl logs statefulset/united-manufacturing-hub-factoryinput -n united-manufacturing-hub --all-containers --prefix > ./install-umh-step/statefulset-factoryinput.log 2> /dev/null
          kubectl logs statefulset/united-manufacturing-hub-hivemqce -n united-manufacturing-hub --all-containers --prefix > ./install-umh-step/statefulset-hivemqce.log 2> /dev/null
          kubectl logs statefulset/united-manufacturing-hub-kafka -n united-manufacturing-hub --all-containers --prefix > ./install-umh-step/statefulset-kafka.log 2> /dev/null
          kubectl logs statefulset/united-manufacturing-hub-nodered -n united-manufacturing-hub --all-containers --prefix > ./install-umh-step/statefulset-nodered.log 2> /dev/null
          kubectl logs statefulset/united-manufacturing-hub-redis-node -n united-manufacturing-hub --all-containers --prefix > ./install-umh-step/statefulset-redis-node.log 2> /dev/null
          kubectl logs statefulset/united-manufacturing-hub-timescaledb -n united-manufacturing-hub --all-containers --prefix > ./install-umh-step/statefulset-timescaledb.log 2> /dev/null
          kubectl logs statefulset/united-manufacturing-hub-zookeeper -n united-manufacturing-hub --all-containers --prefix > ./install-umh-step/statefulset-zookeeper.log 2> /dev/null
          helm status united-manufacturing-hub -n united-manufacturing-hub > ./install-umh-step/helm-status.log 2> /dev/null
          kubectl get po,svc -n united-manufacturing-hub > ./install-umh-step/po-svc.log 2> /dev/null
          kubectl describe po -n united-manufacturing-hub > ./install-umh-step/po-describe.log 2> /dev/null
          kubectl describe svc -n united-manufacturing-hub > ./install-umh-step/svc-describe.log 2> /dev/null
          kubectl get events -n united-manufacturing-hub > ./install-umh-step/events.log 2> /dev/null
      - name: Build test image
        id: build-test-image
        run: |
          docker build -t data-flow-test -f ./test/Dockerfile ./test
          k3d image import data-flow-test -c united-manufacturing-hub
      - name: Run Data Flow Test Job
        id: run-data-flow-test
        run: |
          kubectl apply -f ./test/data-flow-test-job.yaml -n united-manufacturing-hub
          kubectl wait --for=condition=complete job/data-flow-test -n united-manufacturing-hub --timeout=5m
          echo "Data Flow Test Job succeeded"
          kubectl logs job/data-flow-test -n united-manufacturing-hub
      - name: Debug Data Flow failure
        id: debug-data-flow-failure
        if: ${{ failure() && steps.run-data-flow-test.outcome == 'failure'  }}
        run: |
          mkdir -p ./run-data-flow-step
          kubectl logs job/data-flow-test -n united-manufacturing-hub > ./run-data-flow-step/job-data-flow-test.log 2> /dev/null
          kubectl logs deployment/united-manufacturing-hub-opcuasimulator-deployment -n united-manufacturing-hub --all-containers --prefix > ./run-data-flow-step/deployment-opcuasimulator.log 2> /dev/null
          kubectl logs deployment/united-manufacturing-hub-factoryinsight-deployment -n united-manufacturing-hub --all-containers --prefix > ./run-data-flow-step/deployment-factoryinsight.log 2> /dev/null
          kubectl logs deployment/united-manufacturing-hub-grafanaproxy -n united-manufacturing-hub --all-containers --prefix > ./run-data-flow-step/deployment-grafanaproxy.log 2> /dev/null
          kubectl logs deployment/united-manufacturing-hub-iotsensorsmqtt -n united-manufacturing-hub --all-containers --prefix > ./run-data-flow-step/deployment-iotsensormqtt.log 2> /dev/null
          kubectl logs deployment/united-manufacturing-hub-grafana -n united-manufacturing-hub --all-containers --prefix > ./run-data-flow-step/deployment-grafana.log 2> /dev/null
          kubectl logs deployment/united-manufacturing-hub-kafkatopostgresql -n united-manufacturing-hub --all-containers --prefix > ./run-data-flow-step/deployment-kafkatopostgresql.log 2> /dev/null
          kubectl logs deployment/united-manufacturing-hub-mqttkafkabridge -n united-manufacturing-hub --all-containers --prefix > ./run-data-flow-step/deployment-mqttkafkabridge.log 2> /dev/null
          kubectl logs deployment/united-manufacturing-hub-console -n united-manufacturing-hub --all-containers --prefix > ./run-data-flow-step/deployment-console.log 2> /dev/null
          kubectl logs deployment/united-manufacturing-hub-packmlmqttsimulator -n united-manufacturing-hub --all-containers --prefix > ./run-data-flow-step/deployment-packmlmqttsimulator.log 2> /dev/null
          kubectl logs statefulset/united-manufacturing-hub-factoryinput -n united-manufacturing-hub --all-containers --prefix > ./run-data-flow-step/statefulset-factoryinput.log 2> /dev/null
          kubectl logs statefulset/united-manufacturing-hub-hivemqce -n united-manufacturing-hub --all-containers --prefix > ./run-data-flow-step/statefulset-hivemqce.log 2> /dev/null
          kubectl logs statefulset/united-manufacturing-hub-kafka -n united-manufacturing-hub --all-containers --prefix > ./run-data-flow-step/statefulset-kafka.log 2> /dev/null
          kubectl logs statefulset/united-manufacturing-hub-nodered -n united-manufacturing-hub --all-containers --prefix > ./run-data-flow-step/statefulset-nodered.log 2> /dev/null
          kubectl logs statefulset/united-manufacturing-hub-redis-node -n united-manufacturing-hub --all-containers --prefix > ./run-data-flow-step/statefulset-redis-node.log 2> /dev/null
          kubectl logs statefulset/united-manufacturing-hub-timescaledb -n united-manufacturing-hub --all-containers --prefix > ./run-data-flow-step/statefulset-timescaledb.log 2> /dev/null
          kubectl logs statefulset/united-manufacturing-hub-zookeeper -n united-manufacturing-hub --all-containers --prefix > ./run-data-flow-step/statefulset-zookeeper.log 2> /dev/null
          kubectl get po,svc -n united-manufacturing-hub > ./run-data-flow-step/po-svc.log 2> /dev/null
          kubectl describe po -n united-manufacturing-hub > ./run-data-flow-step/po-describe.log 2> /dev/null
          kubectl describe svc -n united-manufacturing-hub > ./run-data-flow-step/svc-describe.log 2> /dev/null
          kubectl get events -n united-manufacturing-hub > ./run-data-flow-step/events.log 2> /dev/null
      - name: Upload failed test logs
        id: upload-failed-test-logs
        if: failure()
        uses: actions/upload-artifact@v2
        with:
          name: data-flow-test-logs
          path: |
            ./install-umh-step
            ./run-data-flow-step
          if-no-files-found: ignore
      - name: Delete k3d cluster
        id: delete-k3d
        if: always()
        run: |
          k3d cluster delete umh-full

  upgrade-test:
    name: Upgrade Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Prepare k3d cluster
        id: prepare-k3d
        uses: AbsaOSS/k3d-action@v2
        with:
          cluster-name: "umh-full"
          args: --agents 1 --image rancher/k3s:v1.24.4-k3s1
      - name: Install UMH latest
        id: install-umh-latest
        run: |
          helm repo add united-manufacturing-hub https://repo.umh.app/
          helm repo update
          helm install united-manufacturing-hub united-manufacturing-hub/united-manufacturing-hub -f ./test/test-values-full.yaml --namespace united-manufacturing-hub --create-namespace --wait --timeout 7m --debug
      - name: Debug Install UMH failure
        id: debug-install-umh-failure
        if: ${{ failure() && steps.install-umh-latest.outcome == 'failure' }}
        run: |
          mkdir -p ./install-umh-latest-step
          kubectl logs deployment/united-manufacturing-hub-opcuasimulator-deployment -n united-manufacturing-hub --all-containers --prefix > ./install-umh-latest-step/deployment-opcuasimulator.log 2> /dev/null
          kubectl logs deployment/united-manufacturing-hub-factoryinsight-deployment -n united-manufacturing-hub --all-containers --prefix > ./install-umh-latest-step/deployment-factoryinsight.log 2> /dev/null
          kubectl logs deployment/united-manufacturing-hub-grafanaproxy -n united-manufacturing-hub --all-containers --prefix > ./install-umh-latest-step/deployment-grafanaproxy.log 2> /dev/null
          kubectl logs deployment/united-manufacturing-hub-iotsensorsmqtt -n united-manufacturing-hub --all-containers --prefix > ./install-umh-latest-step/deployment-iotsensormqtt.log 2> /dev/null
          kubectl logs deployment/united-manufacturing-hub-grafana -n united-manufacturing-hub --all-containers --prefix > ./install-umh-latest-step/deployment-grafana.log 2> /dev/null
          kubectl logs deployment/united-manufacturing-hub-kafkatopostgresql -n united-manufacturing-hub --all-containers --prefix > ./install-umh-latest-step/deployment-kafkatopostgresql.log 2> /dev/null
          kubectl logs deployment/united-manufacturing-hub-mqttkafkabridge -n united-manufacturing-hub --all-containers --prefix > ./install-umh-latest-step/deployment-mqttkafkabridge.log 2> /dev/null
          kubectl logs deployment/united-manufacturing-hub-console -n united-manufacturing-hub --all-containers --prefix > ./install-umh-latest-step/deployment-console.log 2> /dev/null
          kubectl logs deployment/united-manufacturing-hub-packmlmqttsimulator -n united-manufacturing-hub --all-containers --prefix > ./install-umh-latest-step/deployment-packmlmqttsimulator.log 2> /dev/null
          kubectl logs statefulset/united-manufacturing-hub-factoryinput -n united-manufacturing-hub --all-containers --prefix > ./install-umh-latest-step/statefulset-factoryinput.log 2> /dev/null
          kubectl logs statefulset/united-manufacturing-hub-hivemqce -n united-manufacturing-hub --all-containers --prefix > ./install-umh-latest-step/statefulset-hivemqce.log 2> /dev/null
          kubectl logs statefulset/united-manufacturing-hub-kafka -n united-manufacturing-hub --all-containers --prefix > ./install-umh-latest-step/statefulset-kafka.log 2> /dev/null
          kubectl logs statefulset/united-manufacturing-hub-nodered -n united-manufacturing-hub --all-containers --prefix > ./install-umh-latest-step/statefulset-nodered.log 2> /dev/null
          kubectl logs statefulset/united-manufacturing-hub-redis-node -n united-manufacturing-hub --all-containers --prefix > ./install-umh-latest-step/statefulset-redis-node.log 2> /dev/null
          kubectl logs statefulset/united-manufacturing-hub-timescaledb -n united-manufacturing-hub --all-containers --prefix > ./install-umh-latest-step/statefulset-timescaledb.log 2> /dev/null
          kubectl logs statefulset/united-manufacturing-hub-zookeeper -n united-manufacturing-hub --all-containers --prefix > ./install-umh-latest-step/statefulset-zookeeper.log 2> /dev/null
          helm status united-manufacturing-hub -n united-manufacturing-hub > ./install-umh-latest-step/helm-status.log 2> /dev/null
          kubectl get po,svc -n united-manufacturing-hub > ./install-umh-latest-step/po-svc.log 2> /dev/null
          kubectl describe po -n united-manufacturing-hub > ./install-umh-latest-step/po-describe.log 2> /dev/null
          kubectl describe svc -n united-manufacturing-hub > ./install-umh-latest-step/svc-describe.log 2> /dev/null
          kubectl get events -n united-manufacturing-hub > ./install-umh-latest-step/events.log 2> /dev/null
      - name: Upgrade UMH
        id: upgrade-umh
        run: |
          kubectl delete deployment united-manufacturing-hub-factoryinsight-deployment -n united-manufacturing-hub 
          kubectl delete deployment united-manufacturing-hub-iotsensorsmqtt -n united-manufacturing-hub 
          kubectl delete deployment united-manufacturing-hub-kafkatopostgresql -n united-manufacturing-hub 
          kubectl delete deployment united-manufacturing-hub-mqttkafkabridge -n united-manufacturing-hub 
          kubectl delete statefulset united-manufacturing-hub-nodered -n united-manufacturing-hub 
          helm upgrade united-manufacturing-hub ./deployment/united-manufacturing-hub -f ./test/test-values-full.yaml --namespace united-manufacturing-hub --wait --timeout 7m --debug
          kubectl get po,svc -n united-manufacturing-hub
      - name: Debug Upgrade UMH failure
        id: debug-upgrade-umh-failure
        if: ${{ failure() && steps.upgrade-umh.outcome == 'failure' }}
        run: |
          mkdir -p ./upgrade-umh-step
          kubectl logs deployment/united-manufacturing-hub-opcuasimulator-deployment -n united-manufacturing-hub --all-containers --prefix > ./upgrade-umh-step/deployment-opcuasimulator.log 2> /dev/null
          kubectl logs deployment/united-manufacturing-hub-factoryinsight-deployment -n united-manufacturing-hub --all-containers --prefix > ./upgrade-umh-step/deployment-factoryinsight.log 2> /dev/null
          kubectl logs deployment/united-manufacturing-hub-grafanaproxy -n united-manufacturing-hub --all-containers --prefix > ./upgrade-umh-step/deployment-grafanaproxy.log 2> /dev/null
          kubectl logs deployment/united-manufacturing-hub-iotsensorsmqtt -n united-manufacturing-hub --all-containers --prefix > ./upgrade-umh-step/deployment-iotsensormqtt.log 2> /dev/null
          kubectl logs deployment/united-manufacturing-hub-grafana -n united-manufacturing-hub --all-containers --prefix > ./upgrade-umh-step/deployment-grafana.log 2> /dev/null
          kubectl logs deployment/united-manufacturing-hub-kafkatopostgresql -n united-manufacturing-hub --all-containers --prefix > ./upgrade-umh-step/deployment-kafkatopostgresql.log 2> /dev/null
          kubectl logs deployment/united-manufacturing-hub-mqttkafkabridge -n united-manufacturing-hub --all-containers --prefix > ./upgrade-umh-step/deployment-mqttkafkabridge.log 2> /dev/null
          kubectl logs deployment/united-manufacturing-hub-console -n united-manufacturing-hub --all-containers --prefix > ./upgrade-umh-step/deployment-console.log 2> /dev/null
          kubectl logs deployment/united-manufacturing-hub-packmlmqttsimulator -n united-manufacturing-hub --all-containers --prefix > ./upgrade-umh-step/deployment-packmlmqttsimulator.log 2> /dev/null
          kubectl logs statefulset/united-manufacturing-hub-factoryinput -n united-manufacturing-hub --all-containers --prefix > ./upgrade-umh-step/statefulset-factoryinput.log 2> /dev/null
          kubectl logs statefulset/united-manufacturing-hub-hivemqce -n united-manufacturing-hub --all-containers --prefix > ./upgrade-umh-step/statefulset-hivemqce.log 2> /dev/null
          kubectl logs statefulset/united-manufacturing-hub-kafka -n united-manufacturing-hub --all-containers --prefix > ./upgrade-umh-step/statefulset-kafka.log 2> /dev/null
          kubectl logs statefulset/united-manufacturing-hub-nodered -n united-manufacturing-hub --all-containers --prefix > ./upgrade-umh-step/statefulset-nodered.log 2> /dev/null
          kubectl logs statefulset/united-manufacturing-hub-redis-node -n united-manufacturing-hub --all-containers --prefix > ./upgrade-umh-step/statefulset-redis-node.log 2> /dev/null
          kubectl logs statefulset/united-manufacturing-hub-timescaledb -n united-manufacturing-hub --all-containers --prefix > ./upgrade-umh-step/statefulset-timescaledb.log 2> /dev/null
          kubectl logs statefulset/united-manufacturing-hub-zookeeper -n united-manufacturing-hub --all-containers --prefix > ./upgrade-umh-step/statefulset-zookeeper.log 2> /dev/null
          helm status united-manufacturing-hub -n united-manufacturing-hub > ./upgrade-umh-step/helm-status.log 2> /dev/null
          kubectl get po,svc -n united-manufacturing-hub > ./upgrade-umh-step/po-svc.log 2> /dev/null
          kubectl describe po -n united-manufacturing-hub > ./upgrade-umh-step/po-describe.log 2> /dev/null
          kubectl describe svc -n united-manufacturing-hub > ./upgrade-umh-step/svc-describe.log 2> /dev/null
          kubectl get events -n united-manufacturing-hub > ./upgrade-umh-step/events.log 2> /dev/null
      - name: Build test image
        id: build-test-image
        run: |
          docker build -t data-flow-test -f ./test/Dockerfile ./test
          k3d image import data-flow-test -c united-manufacturing-hub
      - name: Run Data Flow Test Job
        id: run-data-flow-test
        run: |
          kubectl apply -f ./test/data-flow-test-job.yaml -n united-manufacturing-hub
          kubectl wait --for=condition=complete job/data-flow-test -n united-manufacturing-hub --timeout=5m
          echo "Data Flow Test Job succeeded"
          kubectl logs job/data-flow-test -n united-manufacturing-hub
      - name: Debug Data Flow failure
        id: debug-data-flow-failure
        if: ${{ failure() && steps.run-data-flow-test.outcome == 'failure' }}
        run: |
          mkdir -p ./run-data-flow-test-step
          kubectl logs job/data-flow-test -n united-manufacturing-hub > ./run-data-flow-test-step/jobs-data-flow-test.log 2> /dev/null
          kubectl logs deployment/united-manufacturing-hub-opcuasimulator-deployment -n united-manufacturing-hub --all-containers --prefix > ./run-data-flow-step/deployment-opcuasimulator.log 2> /dev/null
          kubectl logs deployment/united-manufacturing-hub-factoryinsight-deployment -n united-manufacturing-hub --all-containers --prefix > ./run-data-flow-step/deployment-factoryinsight.log 2> /dev/null
          kubectl logs deployment/united-manufacturing-hub-grafanaproxy -n united-manufacturing-hub --all-containers --prefix > ./run-data-flow-step/deployment-grafanaproxy.log 2> /dev/null
          kubectl logs deployment/united-manufacturing-hub-iotsensorsmqtt -n united-manufacturing-hub --all-containers --prefix > ./run-data-flow-step/deployment-iotsensormqtt.log 2> /dev/null
          kubectl logs deployment/united-manufacturing-hub-grafana -n united-manufacturing-hub --all-containers --prefix > ./run-data-flow-step/deployment-grafana.log 2> /dev/null
          kubectl logs deployment/united-manufacturing-hub-kafkatopostgresql -n united-manufacturing-hub --all-containers --prefix > ./run-data-flow-step/deployment-kafkatopostgresql.log 2> /dev/null
          kubectl logs deployment/united-manufacturing-hub-mqttkafkabridge -n united-manufacturing-hub --all-containers --prefix > ./run-data-flow-step/deployment-mqttkafkabridge.log 2> /dev/null
          kubectl logs deployment/united-manufacturing-hub-console -n united-manufacturing-hub --all-containers --prefix > ./run-data-flow-step/deployment-console.log 2> /dev/null
          kubectl logs deployment/united-manufacturing-hub-packmlmqttsimulator -n united-manufacturing-hub --all-containers --prefix > ./run-data-flow-step/deployment-packmlmqttsimulator.log 2> /dev/null
          kubectl logs statefulset/united-manufacturing-hub-factoryinput -n united-manufacturing-hub --all-containers --prefix > ./run-data-flow-step/statefulset-factoryinput.log 2> /dev/null
          kubectl logs statefulset/united-manufacturing-hub-hivemqce -n united-manufacturing-hub --all-containers --prefix > ./run-data-flow-step/statefulset-hivemqce.log 2> /dev/null
          kubectl logs statefulset/united-manufacturing-hub-kafka -n united-manufacturing-hub --all-containers --prefix > ./run-data-flow-step/statefulset-kafka.log 2> /dev/null
          kubectl logs statefulset/united-manufacturing-hub-nodered -n united-manufacturing-hub --all-containers --prefix > ./run-data-flow-step/statefulset-nodered.log 2> /dev/null
          kubectl logs statefulset/united-manufacturing-hub-redis-node -n united-manufacturing-hub --all-containers --prefix > ./run-data-flow-step/statefulset-redis-node.log 2> /dev/null
          kubectl logs statefulset/united-manufacturing-hub-timescaledb -n united-manufacturing-hub --all-containers --prefix > ./run-data-flow-step/statefulset-timescaledb.log 2> /dev/null
          kubectl logs statefulset/united-manufacturing-hub-zookeeper -n united-manufacturing-hub --all-containers --prefix > ./run-data-flow-step/statefulset-zookeeper.log 2> /dev/null
          kubectl get po,svc -n united-manufacturing-hub > ./run-data-flow-test-step/po-svc.log 2> /dev/null
          kubectl describe po -n united-manufacturing-hub > ./run-data-flow-test-step/po-describe.log 2> /dev/null
          kubectl describe svc -n united-manufacturing-hub > ./run-data-flow-test-step/svc-describe.log 2> /dev/null
          kubectl get events -n united-manufacturing-hub > ./run-data-flow-test-step/events.log 2> /dev/null
      - name: Upload failed test logs
        id: upload-failed-test-logs
        if: failure()
        uses: actions/upload-artifact@v2
        with:
          name: upgrade-test-logs
          path: |
            ./install-umh-latest-step
            ./upgrade-umh-step
            ./run-data-flow-test-step
          if-no-files-found: ignore
      - name: Delete k3d cluster
        id: delete-k3d
        if: always()
        run: |
          k3d cluster delete umh-full
