# Default values for factorycube-helm.

##### CONFIG FOR VERNEMQ #####

vernemq:
  replicaCount: 1

  image:
    repository: vernemq/vernemq
    tag: 1.11.0-alpine
    pullPolicy: IfNotPresent

  service:
    type: LoadBalancer
    mqtt:
      enabled: true
      port: 1883
      # This is the port used by nodes to expose the service
      nodePort: 1883
    annotations: {}
    labels: {}

  ## VerneMQ resources requests and limits
  ## Ref: http://kubernetes.io/docs/user-guide/compute-resources
  resources: {}
    ## We usually recommend not to specify default resources and to leave this as a conscious
    ## choice for the user. This also increases chances charts run on environments with little
    ## resources, such as Minikube. If you do want to specify resources, uncomment the following
    ## lines, adjust them as necessary, and remove the curly braces after 'resources:'.
  #  limits:
  #    cpu: 1
  #    memory: 256Mi
  #  requests:
  #    cpu: 1
  #    memory: 256Mi

  ## Node labels for pod assignment
  ## Ref: https://kubernetes.io/docs/concepts/configuration/assign-pod-node/#nodeselector
  nodeSelector: {}

  ## Node tolerations for pod assignment
  ## Ref: https://kubernetes.io/docs/concepts/configuration/assign-pod-node/#taints-and-tolerations-beta-feature
  tolerations: []

  ## Pod affinity
  ## Ref: https://kubernetes.io/docs/concepts/configuration/assign-pod-node/#affinity-and-anti-affinity
  podAntiAffinity: soft

  securityContext:
    runAsUser: 10000
    runAsGroup: 10000
    fsGroup: 10000

  ## If RBAC is enabled on the cluster,VerneMQ needs a service account
  ## with permissisions sufficient to list pods
  rbac:
    create: true
    serviceAccount:
      create: true
      ## Service account name to be used.
      ## If not set and serviceAccount.create is true a name is generated using the fullname template.
  #    name:

  persistentVolume:
    ## If true, VerneMQ will create/use a Persistent Volume Claim
    ## If false, use local directory
    enabled: true

    ## VerneMQ data Persistent Volume access modes
    ## Must match those of existing PV or dynamic provisioner
    ## Ref: http://kubernetes.io/docs/user-guide/persistent-volumes/
    accessModes:
      - ReadWriteOnce

    ## VerneMQ data Persistent Volume size
    size: 5Gi

    ## VerneMQ data Persistent Volume Storage Class
    ## If defined, storageClassName: <storageClass>
    ## If set to "-", storageClassName: "", which disables dynamic provisioning
    ## If undefined (the default) or set to null, no storageClassName spec is
    ##   set, choosing the default provisioner.  (gp2 on AWS, standard on
    ##   GKE, AWS & OpenStack)
  #  storageClass: ""

    ## Annotations for Persistent Volume Claim
    annotations: {}

  extraVolumeMounts: []
  ## Additional volumeMounts to the pod.
  #  - name: additional-volume-mount
  #    mountPath: /var/additional-volume-path

  extraVolumes: []
  ## Additional volumes to the pod.
  #  - name: additional-volume
  #    emptyDir: {}

  # A list of secrets and their paths to mount inside the pod
  # This is useful for mounting certificates for security (tls)
  secretMounts: 
    - name: vernemq-certificates
      secretName: vernemq-certificates-secret
      path: /etc/ssl/vernemq

  statefulset:
    ## Start and stop pods in Parallel or OrderedReady (one-by-one.)  Note - Can not change after first release.
    ## Ref: https://kubernetes.io/docs/tutorials/stateful-application/basic-stateful-set/#pod-management-policy
    podManagementPolicy: OrderedReady
    ## Statefulsets rolling update update strategy
    ## Ref: https://kubernetes.io/docs/tutorials/stateful-application/basic-stateful-set/#rolling-update
    updateStrategy: RollingUpdate
    ## Configure how much time VerneMQ takes to move offline queues to other nodes
    ## Ref: https://vernemq.com/docs/clustering/#detailed-cluster-leave-case-a-make-a-live-node-leave
    terminationGracePeriodSeconds: 60
    ## Liveness and Readiness probe values
    ## Ref: https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-probes
    livenessProbe:
      initialDelaySeconds: 20
      periodSeconds: 10
      timeoutSeconds: 5
      successThreshold: 1
      failureThreshold: 3
    readinessProbe:
      initialDelaySeconds: 20
      periodSeconds: 10
      timeoutSeconds: 5
      successThreshold: 1
      failureThreshold: 3
    podAnnotations: {}
  #    prometheus.io/scrape: "true"
  #    prometheus.io/port: "8888"
    annotations: {}
    labels: {}
    lifecycle: {}

  pdb:
    enabled: true
    minAvailable: 1
    # maxUnavailable: 1

  ## VerneMQ settings

  additionalEnv:
    - name: DOCKER_VERNEMQ_ALLOW_REGISTER_DURING_NETSPLIT
      value: "on"
    - name: DOCKER_VERNEMQ_ALLOW_PUBLISH_DURING_NETSPLIT
      value: "on"
    - name: DOCKER_VERNEMQ_ALLOW_SUBSCRIBE_DURING_NETSPLIT
      value: "on"
    - name: DOCKER_VERNEMQ_ALLOW_UNSUBSCRIBE_DURING_NETSPLIT
      value: "on"
    - name: DOCKER_VERNEMQ_ALLOW_ANONYMOUS
      value: "on"
    - name: DOCKER_VERNEMQ_MAX_ONLINE_MESSAGES
      value: "-1"
    - name: DOCKER_VERNEMQ_MAX_OFFLINE_MESSAGES
      value: "-1"

    - name: DOCKER_VERNEMQ_ACCEPT_EULA 
      value: "yes"

    - name: DOCKER_VERNEMQ_PLUGINS__VMQ_BRIDGE
      value: "on"

    - name: DOCKER_VERNEMQ_VMQ_BRIDGE__SSL__BR0
      valueFrom:
        configMapKeyRef:
          name: general-configuration
          key: remoteURL
    - name: DOCKER_VERNEMQ_VMQ_BRIDGE__SSL__BR0__TOPIC__1
      valueFrom:
        configMapKeyRef:
          name: general-configuration
          key: mqttBridgeTopic
    - name: DOCKER_VERNEMQ_VMQ_BRIDGE__SSL__BR0__CLIENT_ID
      valueFrom:
        configMapKeyRef:
          name: general-configuration
          key: serial_number

    - name: DOCKER_VERNEMQ_VMQ_BRIDGE__SSL__BR0__CAFILE
      value: "/etc/ssl/vernemq/ca.crt"
    - name: DOCKER_VERNEMQ_VMQ_BRIDGE__SSL__BR0__CERTFILE
      value: "/etc/ssl/vernemq/tls.crt"
    - name: DOCKER_VERNEMQ_VMQ_BRIDGE__SSL__BR0__KEYFILE
      value: "/etc/ssl/vernemq/tls.key"

    - name: DOCKER_VERNEMQ_VMQ_BRIDGE__SSL__BR0__CLEANSESSION
      value: "off"
    - name: DOCKER_VERNEMQ_VMQ_BRIDGE__SSL__BR0__try_private
      value: "off"
    - name: DOCKER_VERNEMQ_VMQ_BRIDGE__SSL__BR0__MAX_OUTGOING_BUFFERED_MESSAGES
      value: "5000000"