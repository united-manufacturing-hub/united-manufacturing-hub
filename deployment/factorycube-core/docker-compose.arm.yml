version: '3.7'
services:
  ### MQTT broker
  # Central container to which al the other connect.
  mqtt-broker:
    image: eclipse-mosquitto:latest
    container_name: ia_mosquitto
    restart: always
    networks:
      - factory_cube
    ports:
      - '8883:8883'
    logging:
      driver: "json-file"
      options:
          max-file: "5"
          max-size: "10m"
    volumes:
      - './persistentData/mosquitto/config:/mosquitto/config:ro'
      - './persistentData/mosquitto/SSL_certs:/mosquitto/SSL_certs:ro'
      - './persistentData/mosquitto/data:/mosquitto/data'
    
  ### IO Link converter
  # Reads sensor data and forwards it to the MQTT Broker
  iolinkconverter:
    image: iaindustrialanalytics.azurecr.io/ia-iolinkconverter:latest
    container_name: ia_iolinkconverter
    restart: unless-stopped
    networks:
      - factory_cube
    logging:
        driver: "json-file"
        options:
            max-file: "5"
            max-size: "10m"
    environment:
      - PYTHONUNBUFFERED=0
      - TRANSMITTERID=${CUBE_TRANSMITTERID}
      - BROKER_URL=ia_mosquitto
      - BROKER_PORT=8883
      - IP_RANGE=${IOLINK_IP_RANGE}
      - FREQUENCY_IN_HZ=${IOLINK_FREQUENCY_IN_HZ}
  
# Create a network for all containers
networks:
  factory_cube:
    name: factory_cube_network
    driver: bridge


  
