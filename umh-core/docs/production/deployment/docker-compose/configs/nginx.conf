# ==============================================================================
# NGINX Configuration for UMH Core - Security Layer
# ==============================================================================
# Purpose: Security-first reverse proxy for industrial edge deployments
#
# Why NGINX is included by default:
# 1. Port Isolation: umh-core internal ports (8040, 8051) not directly exposed
# 2. Security Headers: X-Frame-Options, X-Content-Type-Options, X-XSS-Protection
# 3. Request Filtering: Control access before reaching application
# 4. Industry Standard: Follows Siemens Industrial Edge and Azure IoT Edge patterns
#
# Production additions (not included in this example):
# - TLS/SSL termination (listen 443 ssl)
# - Rate limiting (limit_req_zone)
# - IP whitelisting (allow/deny directives)
# - Authentication (auth_basic or external auth service)

events {
    worker_connections 1024;
}

http {
    # Basic settings
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;
    client_max_body_size 10M;

    # Logging
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log warn;

    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;

    # CORS headers (allow web clients to access webhook endpoints)
    map $request_method $cors_method {
        OPTIONS 1;
        default 0;
    }

    # Upstream servers
    upstream umh_webhook {
        server umh-core:8040;
    }

    server {
        listen 8080;
        server_name _;

        # Health check endpoint
        location / {
            return 200 "NGINX reverse proxy for UMH Core\n";
            add_header Content-Type text/plain;
        }

        # ======================================================================
        # Webhook Endpoint
        # ======================================================================
        # Routes to umh-core:8040 (HTTP input for data flows)
        # Example: POST http://localhost:8081/webhook/my-endpoint
        location /webhook/ {
            # CORS preflight
            if ($cors_method = 1) {
                add_header 'Access-Control-Allow-Origin' '*' always;
                add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
                add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization' always;
                add_header 'Access-Control-Max-Age' 1728000;
                add_header 'Content-Type' 'text/plain; charset=utf-8';
                add_header 'Content-Length' 0;
                return 204;
            }

            # CORS for actual requests
            add_header 'Access-Control-Allow-Origin' '*' always;
            add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
            add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization' always;
            add_header 'Access-Control-Expose-Headers' 'Content-Length,Content-Range' always;

            # Proxy settings
            proxy_pass http://umh_webhook;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # Timeouts (adjust based on your data flow processing time)
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;

            # Buffering (disable for streaming responses)
            proxy_buffering off;

            # Request logging (for security monitoring)
            access_log /var/log/nginx/webhook_access.log;
            error_log /var/log/nginx/webhook_error.log;
        }
    }
}

# ==============================================================================
# Security Notes
# ==============================================================================
# 1. This config provides basic security (port isolation, headers)
# 2. For production, add:
#    - TLS/SSL termination (listen 443 ssl)
#    - Rate limiting (limit_req_zone, limit_req)
#    - IP whitelisting (allow/deny directives)
#    - Authentication (auth_basic or external auth service)
# 3. CORS is wide open (Access-Control-Allow-Origin: *)
#    - Restrict to specific origins in production
# 4. Monitor logs for security events
# 5. See deployment-security.md for complete security requirements

# ==============================================================================
# Maintenance Notes
# ==============================================================================
# Test configuration: docker compose exec nginx nginx -t
# Reload configuration: docker compose exec nginx nginx -s reload
# View logs: docker compose logs -f nginx
