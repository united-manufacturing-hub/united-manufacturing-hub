# Copyright 2025 UMH Systems GmbH
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# NOTE: This workflow only sets nightly/stable versions through the management console webhook.
# Enterprise versions are NOT set here - they must be set directly in the database.

name: Build UMH Core

on:
  pull_request:
    branches:
      - "**"
  push:
    branches:
      - staging
      - main
    tags:
      - "v*"
  merge_group:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: united-manufacturing-hub/umh-core

jobs:
  build:
    name: Build and Push
    permissions:
      contents: read
      packages: write
    timeout-minutes: 60
    runs-on: depot-ubuntu-24.04
    steps:
      - uses: actions/checkout@v6

      - name: Setup Depot
        uses: depot/setup-action@b0b1ea4f69e92ebf5dea3f8713a1b0c37b2126a5 # v1.6.0

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          registry: docker.io
          username: ${{ secrets.DOCKER_READ_ONLY_USER }}
          password: ${{ secrets.DOCKER_READ_ONLY_PAT }}

      - name: Docker meta
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=tag
            type=sha

      - name: Determine version
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            echo "VERSION=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=0.0.0-dev-${{ github.sha }}" >> $GITHUB_OUTPUT
          fi

      - name: Build and Push
        working-directory: ./umh-core
        env:
          DEPOT_PROJECT_ID: ${{ secrets.DEPOT_PROJECT_ID }}
          DEPOT_TOKEN: ${{ secrets.DEPOT_TOKEN }}
        run: |
          # Convert metadata tags to -t flags
          TAGS=""
          while IFS= read -r tag; do
            [ -n "$tag" ] && TAGS="$TAGS -t $tag"
          done <<< "${{ steps.meta.outputs.tags }}"

          make build-depot \
            VERSION=${{ steps.version.outputs.VERSION }} \
            TAGS="$TAGS"

  verify-binaries:
    name: Verify ${{ matrix.arch }} Image
    needs: build
    runs-on: ${{ matrix.runner }}
    timeout-minutes: 10
    permissions:
      contents: read
      packages: read
    strategy:
      fail-fast: false
      matrix:
        arch: [arm64, amd64]
        include:
          - arch: arm64
            runner: depot-ubuntu-24.04-arm
            platform: linux/arm64
            expected_machine: "b700"
            expected_uname: "aarch64"
            arch_name: "ARM aarch64"
          - arch: amd64
            runner: depot-ubuntu-24.04
            platform: linux/amd64
            expected_machine: "3e00"
            expected_uname: "x86_64"
            arch_name: "x86-64"
    steps:
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Verify runner architecture
        run: |
          ARCH=$(uname -m)
          echo "Runner architecture: $ARCH"
          echo "Expected: ${{ matrix.expected_uname }}"
          if [ "$ARCH" != "${{ matrix.expected_uname }}" ]; then
            echo "::error::Not running on expected architecture! Expected: ${{ matrix.expected_uname }}, Got: $ARCH"
            exit 1
          fi

      - name: Pull ${{ matrix.arch }} image with retry
        run: |
          set -euo pipefail
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          IMAGE="ghcr.io/united-manufacturing-hub/umh-core:sha-${SHORT_SHA}"
          echo "IMAGE=$IMAGE" >> $GITHUB_ENV

          echo "Pulling ${{ matrix.arch }} image: $IMAGE"
          MAX_RETRIES=5
          RETRY_DELAY=10

          for i in $(seq 1 $MAX_RETRIES); do
            if docker pull --platform ${{ matrix.platform }} "$IMAGE"; then
              echo "Image pulled successfully"
              exit 0
            fi
            if [ $i -lt $MAX_RETRIES ]; then
              echo "Pull failed, retrying in ${RETRY_DELAY}s... (attempt $i/$MAX_RETRIES)"
              sleep $RETRY_DELAY
              RETRY_DELAY=$((RETRY_DELAY * 2))
            fi
          done

          echo "::error::Failed to pull image after $MAX_RETRIES attempts"
          exit 1

      - name: Verify binary architectures
        env:
          EXPECTED_MACHINE: ${{ matrix.expected_machine }}
          ARCH_NAME: ${{ matrix.arch_name }}
        run: |
          set -euo pipefail

          echo "Checking binary architectures..."
          echo "Expected machine type: $EXPECTED_MACHINE ($ARCH_NAME)"
          # Use od to read ELF header machine type (bytes 18-19)
          # ARM64 = b700, x86-64 = 3e00 (little-endian)
          docker run --rm --platform ${{ matrix.platform }} \
            -e EXPECTED_MACHINE="$EXPECTED_MACHINE" \
            -e ARCH_NAME="$ARCH_NAME" \
            "$IMAGE" sh -c '
            check_binary() {
              local binary=$1
              local machine=$(od -An -tx1 -j18 -N2 "$binary" 2>/dev/null | tr -d " ")

              if [ "$machine" = "$EXPECTED_MACHINE" ]; then
                echo "$binary: $ARCH_NAME"
              else
                echo "$binary: wrong arch ($machine, expected $EXPECTED_MACHINE)"
                return 1
              fi
            }

            failed=0
            # Note: /opt/redpanda/bin/redpanda is a shell wrapper script
            # The actual ELF binary is at /opt/redpanda/libexec/redpanda
            for bin in /usr/local/bin/benthos /opt/redpanda/libexec/redpanda /usr/local/bin/umh-core \
                       /command/s6-svscan /command/s6-supervise /command/execlineb; do
              check_binary "$bin" || failed=1
            done
            exit $failed
          ' | tee /tmp/arch-check.txt

          # Verify expected architecture found
          if ! grep -q "$ARCH_NAME" /tmp/arch-check.txt; then
            echo "::error::Binaries are not $ARCH_NAME!"
            cat /tmp/arch-check.txt
            exit 1
          fi

          echo "All binaries are native $ARCH_NAME"

      - name: Smoke test - verify binaries execute
        run: |
          set -euo pipefail
          echo "Running smoke tests..."

          # Test benthos
          docker run --rm --platform ${{ matrix.platform }} "$IMAGE" benthos --version
          echo "benthos executes"

          # Test umh-core
          docker run --rm --platform ${{ matrix.platform }} "$IMAGE" umh-core --help || true
          echo "umh-core executes"

          # Test S6 (just check it runs, version flag may not exist)
          docker run --rm --platform ${{ matrix.platform }} "$IMAGE" /command/s6-svscan --help 2>&1 || true
          echo "s6-svscan executes"

          echo "All smoke tests passed"

      - name: Add to job summary
        if: always()
        run: |
          echo "## ${{ matrix.arch }} Binary Verification" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Architecture**: ${{ matrix.arch_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Platform**: ${{ matrix.platform }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f /tmp/arch-check.txt ]; then
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat /tmp/arch-check.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

  notify-management-console:
    needs: build
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: depot-ubuntu-24.04
    steps:
      - name: Notify management console
        env:
          UMH_MC_WEBHOOK_SECRET: ${{ secrets.UMH_MC_WEBHOOK_SECRET }}
        run: |
          set -euo pipefail
          VERSION="${{ github.ref_name }}"
          SECRET="$UMH_MC_WEBHOOK_SECRET"

          notify_mc() {
            local base_url=$1

            echo "Notifying $base_url of new version: $VERSION"

            if [[ "$VERSION" == *-pre.* ]]; then
              CHANNEL="nightly"
            else
              CHANNEL="stable"
            fi

            if [[ "$CHANNEL" == "nightly" ]]; then
              # Pre-release, simply update the channel
              curl --fail --silent --show-error --max-time 30 --retry 3 -X POST "$base_url/api/v2/webhook/versions/umh-core/update" \
              -H "X-Webhook-Secret: $SECRET" \
              -H "Content-Type: application/json" \
              -d "{\"channel\":\"${CHANNEL}\",\"version\":\"${VERSION}\"}"
            else
              # Fetch current nightly to check if we can promote it
              NIGHTLY_VERSION=$(curl --fail --silent --show-error --max-time 10 -X GET "$base_url/api/v2/versions/umh-core/nightly" | jq -r '.version')

              # Extract base version from nightly version
              # v0.0.0-pre.1 -> v0.0.0
              NIGHTLY_BASE_VERSION=$(echo "$NIGHTLY_VERSION" | sed -E 's/(-pre\.[0-9]+)$//')

              if [[ "$VERSION" == "$NIGHTLY_BASE_VERSION" ]]; then
                # Promote nightly to stable
                curl --fail --silent --show-error --max-time 30 --retry 3 -X POST "$base_url/api/v2/webhook/versions/umh-core/update" \
                -H "X-Webhook-Secret: $SECRET" \
                -H "Content-Type: application/json" \
                -d "{\"channel\":\"stable\",\"version\":\"${VERSION}\",\"isPromotion\":true,\"promotedFrom\":\"nightly\"}"
              else
                # New stable release without promotion
                curl --fail --silent --show-error --max-time 30 --retry 3 -X POST "$base_url/api/v2/webhook/versions/umh-core/update" \
                -H "X-Webhook-Secret: $SECRET" \
                -H "Content-Type: application/json" \
                -d "{\"channel\":\"stable\",\"version\":\"${VERSION}\"}"
              fi
            fi

            echo "Successfully notified $base_url"
          }

          notify_mc "https://staging.management.umh.app"
          notify_mc "https://management.umh.app"
