# Copyright 2025 UMH Systems GmbH
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# NOTE: This workflow only sets nightly/stable versions through the management console webhook.
# Enterprise versions are NOT set here - they must be set directly in the database.

name: Build UMH Core

on:
  pull_request:
    branches:
      - "**"
  push:
    branches:
      - staging
      - main
    tags:
      - "v*"
  merge_group:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: united-manufacturing-hub/umh-core

jobs:
  build:
    name: Build and Push
    permissions:
      contents: read
      packages: write
    timeout-minutes: 60
    runs-on: depot-ubuntu-24.04
    steps:
      - uses: actions/checkout@v6

      - name: Setup Depot
        uses: depot/setup-action@b0b1ea4f69e92ebf5dea3f8713a1b0c37b2126a5

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          registry: docker.io
          username: ${{ secrets.DOCKER_READ_ONLY_USER }}
          password: ${{ secrets.DOCKER_READ_ONLY_PAT }}

      - name: Docker meta
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=tag
            type=sha

      - name: Determine version
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            echo "VERSION=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=0.0.0-dev-${{ github.sha }}" >> $GITHUB_OUTPUT
          fi

      - name: Build and Push
        working-directory: ./umh-core
        env:
          DEPOT_PROJECT_ID: ${{ secrets.DEPOT_PROJECT_ID }}
          DEPOT_TOKEN: ${{ secrets.DEPOT_TOKEN }}
        run: |
          # Convert metadata tags to -t flags
          TAGS=""
          while IFS= read -r tag; do
            [ -n "$tag" ] && TAGS="$TAGS -t $tag"
          done <<< "${{ steps.meta.outputs.tags }}"

          make build-depot \
            VERSION=${{ steps.version.outputs.VERSION }} \
            TAGS="$TAGS"

  notify-management-console:
    needs: build
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: depot-ubuntu-24.04
    steps:
      - name: Notify management console
        env:
          UMH_MC_WEBHOOK_SECRET: ${{ secrets.UMH_MC_WEBHOOK_SECRET }}
        run: |
          set -euo pipefail
          VERSION="${{ github.ref_name }}"
          SECRET="$UMH_MC_WEBHOOK_SECRET"

          notify_mc() {
            local base_url=$1

            echo "Notifying $base_url of new version: $VERSION"

            if [[ "$VERSION" == *-pre.* ]]; then
              CHANNEL="nightly"
            else
              CHANNEL="stable"
            fi

            if [[ "$CHANNEL" == "nightly" ]]; then
              # Pre-release, simply update the channel
              curl --fail --silent --show-error --max-time 30 --retry 3 -X POST "$base_url/api/v2/webhook/versions/umh-core/update" \
              -H "X-Webhook-Secret: $SECRET" \
              -H "Content-Type: application/json" \
              -d "{\"channel\":\"${CHANNEL}\",\"version\":\"${VERSION}\"}"
            else
              # Fetch current nightly to check if we can promote it
              NIGHTLY_VERSION=$(curl --fail --silent --show-error --max-time 10 -X GET "$base_url/api/v2/versions/umh-core/nightly" | jq -r '.version')

              # Extract base version from nightly version
              # v0.0.0-pre.1 -> v0.0.0
              NIGHTLY_BASE_VERSION=$(echo "$NIGHTLY_VERSION" | sed -E 's/(-pre\.[0-9]+)$//')

              if [[ "$VERSION" == "$NIGHTLY_BASE_VERSION" ]]; then
                # Promote nightly to stable
                curl --fail --silent --show-error --max-time 30 --retry 3 -X POST "$base_url/api/v2/webhook/versions/umh-core/update" \
                -H "X-Webhook-Secret: $SECRET" \
                -H "Content-Type: application/json" \
                -d "{\"channel\":\"stable\",\"version\":\"${VERSION}\",\"isPromotion\":true,\"promotedFrom\":\"nightly\"}"
              else
                # New stable release without promotion
                curl --fail --silent --show-error --max-time 30 --retry 3 -X POST "$base_url/api/v2/webhook/versions/umh-core/update" \
                -H "X-Webhook-Secret: $SECRET" \
                -H "Content-Type: application/json" \
                -d "{\"channel\":\"stable\",\"version\":\"${VERSION}\"}"
              fi
            fi

            echo "Successfully notified $base_url"
          }

          notify_mc "https://staging.management.umh.app"
          notify_mc "https://management.umh.app"
