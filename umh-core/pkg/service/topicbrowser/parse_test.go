// Copyright 2025 UMH Systems GmbH
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//     http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

package topicbrowser

import (
	"encoding/hex"
	"strconv"
	"strings"
	"time"

	"github.com/united-manufacturing-hub/united-manufacturing-hub/umh-core/pkg/constants"
	s6svc "github.com/united-manufacturing-hub/united-manufacturing-hub/umh-core/pkg/service/s6"

	. "github.com/onsi/ginkgo/v2"
	. "github.com/onsi/gomega"
)

// benthos log from samples for topic_browser plugin
const rawLog = `STARTSTARTSTART
0ac2260aea030a106561363132363366626232303663306512d5030a13656e74657270726973652d6f662d6b696e67731a0a5f686973746f7269616e2a096d795f646174615f3432400a0d6b61666b615f6d73675f6b6579122f756d682e76312e656e74657270726973652d6f662d6b696e67732e5f686973746f7269616e2e6d795f646174615f3432380a05746f706963122f756d682e76312e656e74657270726973652d6f662d6b696e67732e5f686973746f7269616e2e6d795f646174615f3432390a0a627269646765645f6279122b70726f746f636f6c2d636f6e7665727465722d756e696d706c656d656e7465642d67656e65726174652d31321b0a0d646174615f636f6e7472616374120a5f686973746f7269616e32240a0d6c6f636174696f6e5f706174681213656e74657270726973652d6f662d6b696e677332150a087461675f6e616d6512096d795f646174615f3432230a126b61666b615f74696d657374616d705f6d73120d3137353138383839343138393932160a105f696e697469616c4d6574616461746112027b7d321b0a0b6b61666b615f746f706963120c756d682e6d65737361676573323c0a09756d685f746f706963122f756d682e76312e656e74657270726973652d6f662d6b696e67732e5f686973746f7269616e2e6d795f646174615f340aea030a103764616531383835383865363162356212d5030a13656e74657270726973652d6f662d6b696e67731a0a5f686973746f7269616e2a096d795f646174615f3632380a05746f706963122f756d682e76312e656e74657270726973652d6f662d6b696e67732e5f686973746f7269616e2e6d795f646174615f3632230a126b61666b615f74696d657374616d705f6d73120d31373531383838393433373233321b0a0b6b61666b615f746f706963120c756d682e6d6573736167657332150a087461675f6e616d6512096d795f646174615f3632240a0d6c6f636174696f6e5f706174681213656e74657270726973652d6f662d6b696e677332160a105f696e697469616c4d6574616461746112027b7d323c0a09756d685f746f706963122f756d682e76312e656e74657270726973652d6f662d6b696e67732e5f686973746f7269616e2e6d795f646174615f3632400a0d6b61666b615f6d73675f6b6579122f756d682e76312e656e74657270726973652d6f662d6b696e67732e5f686973746f7269616e2e6d795f646174615f36321b0a0d646174615f636f6e7472616374120a5f686973746f7269616e32390a0a627269646765645f6279122b70726f746f636f6c2d636f6e7665727465722d756e696d706c656d656e7465642d67656e65726174652d310aea030a103739653737646562623130376431393912d5030a13656e74657270726973652d6f662d6b696e67731a0a5f686973746f7269616e2a096d795f646174615f3732160a105f696e697469616c4d6574616461746112027b7d32380a05746f706963122f756d682e76312e656e74657270726973652d6f662d6b696e67732e5f686973746f7269616e2e6d795f646174615f3732240a0d6c6f636174696f6e5f706174681213656e74657270726973652d6f662d6b696e6773323c0a09756d685f746f706963122f756d682e76312e656e74657270726973652d6f662d6b696e67732e5f686973746f7269616e2e6d795f646174615f37321b0a0d646174615f636f6e7472616374120a5f686973746f7269616e32150a087461675f6e616d6512096d795f646174615f37321b0a0b6b61666b615f746f706963120c756d682e6d6573736167657332390a0a627269646765645f6279122b70726f746f636f6c2d636f6e7665727465722d756e696d706c656d656e7465642d67656e65726174652d3132400a0d6b61666b615f6d73675f6b6579122f756d682e76312e656e74657270726973652d6f662d6b696e67732e5f686973746f7269616e2e6d795f646174615f3732230a126b61666b615f74696d657374616d705f6d73120d313735313838383934343637380aea030a106562643431383765643836313936656312d5030a13656e74657270726973652d6f662d6b696e67731a0a5f686973746f7269616e2a096d795f646174615f39323c0a09756d685f746f706963122f756d682e76312e656e74657270726973652d6f662d6b696e67732e5f686973746f7269616e2e6d795f646174615f3932160a105f696e697469616c4d6574616461746112027b7d321b0a0d646174615f636f6e7472616374120a5f686973746f7269616e32230a126b61666b615f74696d657374616d705f6d73120d3137353138383839343637333532400a0d6b61666b615f6d73675f6b6579122f756d682e76312e656e74657270726973652d6f662d6b696e67732e5f686973746f7269616e2e6d795f646174615f3932380a05746f706963122f756d682e76312e656e74657270726973652d6f662d6b696e67732e5f686973746f7269616e2e6d795f646174615f3932150a087461675f6e616d6512096d795f646174615f3932390a0a627269646765645f6279122b70726f746f636f6c2d636f6e7665727465722d756e696d706c656d656e7465642d67656e65726174652d31321b0a0b6b61666b615f746f706963120c756d682e6d6573736167657332240a0d6c6f636174696f6e5f706174681213656e74657270726973652d6f662d6b696e67730aea030a103663616533373937633863386230623512d5030a13656e74657270726973652d6f662d6b696e67731a0a5f686973746f7269616e2a096d795f646174615f30321b0a0b6b61666b615f746f706963120c756d682e6d6573736167657332400a0d6b61666b615f6d73675f6b6579122f756d682e76312e656e74657270726973652d6f662d6b696e67732e5f686973746f7269616e2e6d795f646174615f3032380a05746f706963122f756d682e76312e656e74657270726973652d6f662d6b696e67732e5f686973746f7269616e2e6d795f646174615f3032390a0a627269646765645f6279122b70726f746f636f6c2d636f6e7665727465722d756e696d706c656d656e7465642d67656e65726174652d3132230a126b61666b615f74696d657374616d705f6d73120d3137353138383839343738313232150a087461675f6e616d6512096d795f646174615f3032160a105f696e697469616c4d6574616461746112027b7d32240a0d6c6f636174696f6e5f706174681213656e74657270726973652d6f662d6b696e6773321b0a0d646174615f636f6e7472616374120a5f686973746f7269616e323c0a09756d685f746f706963122f756d682e76312e656e74657270726973652d6f662d6b696e67732e5f686973746f7269616e2e6d795f646174615f300aea030a106361303037336238636436643634383112d5030a13656e74657270726973652d6f662d6b696e67731a0a5f686973746f7269616e2a096d795f646174615f3232240a0d6c6f636174696f6e5f706174681213656e74657270726973652d6f662d6b696e677332390a0a627269646765645f6279122b70726f746f636f6c2d636f6e7665727465722d756e696d706c656d656e7465642d67656e65726174652d31321b0a0d646174615f636f6e7472616374120a5f686973746f7269616e32380a05746f706963122f756d682e76312e656e74657270726973652d6f662d6b696e67732e5f686973746f7269616e2e6d795f646174615f3232150a087461675f6e616d6512096d795f646174615f3232400a0d6b61666b615f6d73675f6b6579122f756d682e76312e656e74657270726973652d6f662d6b696e67732e5f686973746f7269616e2e6d795f646174615f32323c0a09756d685f746f706963122f756d682e76312e656e74657270726973652d6f662d6b696e67732e5f686973746f7269616e2e6d795f646174615f3232160a105f696e697469616c4d6574616461746112027b7d321b0a0b6b61666b615f746f706963120c756d682e6d6573736167657332230a126b61666b615f74696d657374616d705f6d73120d313735313838383933393638320aea030a103230653838363263343265303635393712d5030a13656e74657270726973652d6f662d6b696e67731a0a5f686973746f7269616e2a096d795f646174615f33321b0a0b6b61666b615f746f706963120c756d682e6d65737361676573321b0a0d646174615f636f6e7472616374120a5f686973746f7269616e32160a105f696e697469616c4d6574616461746112027b7d32150a087461675f6e616d6512096d795f646174615f3332390a0a627269646765645f6279122b70726f746f636f6c2d636f6e7665727465722d756e696d706c656d656e7465642d67656e65726174652d31323c0a09756d685f746f706963122f756d682e76312e656e74657270726973652d6f662d6b696e67732e5f686973746f7269616e2e6d795f646174615f3332400a0d6b61666b615f6d73675f6b6579122f756d682e76312e656e74657270726973652d6f662d6b696e67732e5f686973746f7269616e2e6d795f646174615f3332380a05746f706963122f756d682e76312e656e74657270726973652d6f662d6b696e67732e5f686973746f7269616e2e6d795f646174615f3332230a126b61666b615f74696d657374616d705f6d73120d3137353138383839343037303232240a0d6c6f636174696f6e5f706174681213656e74657270726973652d6f662d6b696e67730aea030a103635626165343039373630666164653612d5030a13656e74657270726973652d6f662d6b696e67731a0a5f686973746f7269616e2a096d795f646174615f38323c0a09756d685f746f706963122f756d682e76312e656e74657270726973652d6f662d6b696e67732e5f686973746f7269616e2e6d795f646174615f38321b0a0d646174615f636f6e7472616374120a5f686973746f7269616e321b0a0b6b61666b615f746f706963120c756d682e6d6573736167657332150a087461675f6e616d6512096d795f646174615f3832400a0d6b61666b615f6d73675f6b6579122f756d682e76312e656e74657270726973652d6f662d6b696e67732e5f686973746f7269616e2e6d795f646174615f3832380a05746f706963122f756d682e76312e656e74657270726973652d6f662d6b696e67732e5f686973746f7269616e2e6d795f646174615f3832390a0a627269646765645f6279122b70726f746f636f6c2d636f6e7665727465722d756e696d706c656d656e7465642d67656e65726174652d3132230a126b61666b615f74696d657374616d705f6d73120d3137353138383839343537313032160a105f696e697469616c4d6574616461746112027b7d32240a0d6c6f636174696f6e5f706174681213656e74657270726973652d6f662d6b696e67730aea030a106632666563363535346535363763353512d5030a13656e74657270726973652d6f662d6b696e67731a0a5f686973746f7269616e2a096d795f646174615f35323c0a09756d685f746f706963122f756d682e76312e656e74657270726973652d6f662d6b696e67732e5f686973746f7269616e2e6d795f646174615f35321b0a0b6b61666b615f746f706963120c756d682e6d6573736167657332240a0d6c6f636174696f6e5f706174681213656e74657270726973652d6f662d6b696e677332390a0a627269646765645f6279122b70726f746f636f6c2d636f6e7665727465722d756e696d706c656d656e7465642d67656e65726174652d3132400a0d6b61666b615f6d73675f6b6579122f756d682e76312e656e74657270726973652d6f662d6b696e67732e5f686973746f7269616e2e6d795f646174615f3532160a105f696e697469616c4d6574616461746112027b7d32380a05746f706963122f756d682e76312e656e74657270726973652d6f662d6b696e67732e5f686973746f7269616e2e6d795f646174615f3532230a126b61666b615f74696d657374616d705f6d73120d31373531383838393432373130321b0a0d646174615f636f6e7472616374120a5f686973746f7269616e32150a087461675f6e616d6512096d795f646174615f350aea030a103162653037636534396663356437613712d5030a13656e74657270726973652d6f662d6b696e67731a0a5f686973746f7269616e2a096d795f646174615f3132390a0a627269646765645f6279122b70726f746f636f6c2d636f6e7665727465722d756e696d706c656d656e7465642d67656e65726174652d3132380a05746f706963122f756d682e76312e656e74657270726973652d6f662d6b696e67732e5f686973746f7269616e2e6d795f646174615f3132400a0d6b61666b615f6d73675f6b6579122f756d682e76312e656e74657270726973652d6f662d6b696e67732e5f686973746f7269616e2e6d795f646174615f3132240a0d6c6f636174696f6e5f706174681213656e74657270726973652d6f662d6b696e677332150a087461675f6e616d6512096d795f646174615f3132160a105f696e697469616c4d6574616461746112027b7d323c0a09756d685f746f706963122f756d682e76312e656e74657270726973652d6f662d6b696e67732e5f686973746f7269616e2e6d795f646174615f3132230a126b61666b615f74696d657374616d705f6d73120d31373531383838393438373933321b0a0d646174615f636f6e7472616374120a5f686973746f7269616e321b0a0b6b61666b615f746f706963120c756d682e6d65737361676573128b040a88040a103162653037636534396663356437613710012ad4030a400a0d6b61666b615f6d73675f6b6579122f756d682e76312e656e74657270726973652d6f662d6b696e67732e5f686973746f7269616e2e6d795f646174615f310a1b0a0d646174615f636f6e7472616374120a5f686973746f7269616e0a150a087461675f6e616d6512096d795f646174615f310a380a05746f706963122f756d682e76312e656e74657270726973652d6f662d6b696e67732e5f686973746f7269616e2e6d795f646174615f310a3c0a09756d685f746f706963122f756d682e76312e656e74657270726973652d6f662d6b696e67732e5f686973746f7269616e2e6d795f646174615f310a160a105f696e697469616c4d6574616461746112027b7d0a1b0a0b6b61666b615f746f706963120c756d682e6d657373616765730a230a126b61666b615f74696d657374616d705f6d73120d313735313838383934383739330a240a0d6c6f636174696f6e5f706174681213656e74657270726973652d6f662d6b696e67730a390a0a627269646765645f6279122b70726f746f636f6c2d636f6e7665727465722d756e696d706c656d656e7465642d67656e65726174652d3112297b2274696d657374616d705f6d73223a313735313838383934383638362c2276616c7565223a32317d38b9dcdfa5fe325214080128cedbdfa5fe321209090000000000003540
ENDDATAENDDATAENDDATA
1751888949547
ENDENDENDEND`

// --------------------------------------------------------------------------

var _ = Describe("extractRaw / parseBlock", func() {
	var (
		compressed []byte // hex line from rawLog
		payload    []byte // expected decoded payload
		epochMS    int64  // timestamp parsed from rawLog
		rb         *Ringbuffer
		service    *Service
	)

	BeforeEach(func() {
		lines := strings.Split(rawLog, "\n")
		hexLine := strings.TrimSpace(lines[1])           // second line is the hex payload
		tsLine := strings.TrimSpace(lines[len(lines)-2]) // epoch
		var err error
		epochMS, err = strconv.ParseInt(tsLine, 10, 64)
		Expect(err).NotTo(HaveOccurred())

		// decode hex to get the expected payload
		payload, err = hex.DecodeString(hexLine)
		Expect(err).NotTo(HaveOccurred())

		compressed = []byte(hexLine)

		rb = NewRingbuffer(4)
		service = &Service{ringbuffer: rb}
	})

	Context("extraction and hex-decoding", func() {
		It("extracts, hex-decodes and stores the block", func() {
			logs := buildLogs(true, string(compressed), epochMS)

			Expect(service.parseBlock(logs)).To(Succeed())
			Expect(rb.Len()).To(Equal(1))

			got := rb.GetSnapshot().Items[0]
			Expect(got.Payload).To(Equal(payload))
			Expect(got.Timestamp).To(Equal(time.UnixMilli(epochMS)))
		})
	})

	Context("incomplete block", func() {
		It("returns without error and without writing", func() {
			logs := []s6svc.LogEntry{
				{Content: constants.BLOCK_START_MARKER},
				{Content: string(compressed)},
			}

			Expect(service.parseBlock(logs)).To(Succeed())
			Expect(rb.Len()).To(Equal(0))
		})
	})

	Context("missing timestamp line", func() {
		It("fails with a clear error", func() {
			logs := buildLogs(false, string(compressed), epochMS)

			err := service.parseBlock(logs)
			Expect(err).To(HaveOccurred())
			Expect(err.Error()).To(ContainSubstring("timestamp line is missing"))
			Expect(rb.Len()).To(Equal(0))
		})
	})

	Context("corrupt hex data", func() {
		It("propagates the hex decode error", func() {
			logs := buildLogs(true, "not-hex-bytes", epochMS)

			err := service.parseBlock(logs)
			Expect(err).To(HaveOccurred())
			Expect(rb.Len()).To(Equal(0))
		})
	})

	Context("origin benthos block ", func() {
		It("processes the full benthos sample", func() {
			var logs []s6svc.LogEntry
			for _, l := range strings.Split(rawLog, "\n") {
				l = strings.TrimSpace(l)
				if l != "" {
					logs = append(logs, s6svc.LogEntry{Content: l})
				}
			}

			Expect(service.parseBlock(logs)).To(Succeed())
			Expect(rb.Len()).To(Equal(1))

			got := rb.GetSnapshot().Items[0]

			Expect(got.Timestamp).To(Equal(time.UnixMilli(epochMS)))
			Expect(got.Payload).To(Equal(payload))
			// check if e.g. the "umh_topic" exists in the payload
			Expect(string(got.Payload)).To(ContainSubstring("umh_topic"))
		})
	})

	Context("duplicate block processing prevention", func() {
		It("does not process the same block multiple times", func() {
			logs := buildLogs(true, string(compressed), epochMS)

			// First call should process the block
			Expect(service.parseBlock(logs)).To(Succeed())
			Expect(rb.Len()).To(Equal(1))

			// Second call with same logs should not add another block
			Expect(service.parseBlock(logs)).To(Succeed())
			Expect(rb.Len()).To(Equal(1)) // Still only 1 block

			// Third call should also not add another block
			Expect(service.parseBlock(logs)).To(Succeed())
			Expect(rb.Len()).To(Equal(1)) // Still only 1 block
		})

		It("processes new blocks when they appear", func() {
			logs1 := buildLogs(true, string(compressed), epochMS)
			logs2 := append(logs1, buildLogs(true, string(compressed), epochMS+1000)...)

			// Process first block
			Expect(service.parseBlock(logs1)).To(Succeed())
			Expect(rb.Len()).To(Equal(1))

			// Process with both blocks - should add the second block
			Expect(service.parseBlock(logs2)).To(Succeed())
			Expect(rb.Len()).To(Equal(2))
		})
	})
})

// buildLogs creates a synthetic Benthos log block for tests.  It wraps the
// supplied hex-encoded data line between BLOCK_START / DATA_END / BLOCK_END
// markers and, if includeTimestamp is true, inserts the given epochMS as the
// timestamp line.  The returned slice is ready to be fed into parseBlock.
func buildLogs(includeTimestamp bool, dataLine string, epochMS int64) []s6svc.LogEntry {
	logs := []s6svc.LogEntry{
		{Content: constants.BLOCK_START_MARKER},
		{Content: dataLine},
		{Content: constants.DATA_END_MARKER},
	}
	if includeTimestamp {
		logs = append(logs, s6svc.LogEntry{Content: strconv.FormatInt(epochMS, 10)})
	}
	logs = append(logs, s6svc.LogEntry{Content: constants.BLOCK_END_MARKER})
	return logs
}
