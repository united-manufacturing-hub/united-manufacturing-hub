name: Test Kubernetes Deployment

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  data-flow-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Prepare k3s cluster
        uses: AbsaOSS/k3d-action@v2
        with:
          cluster-name: "united-manufacturing-hub"
          args: --agents 1 --image rancher/k3s:v1.24.4-k3s1
      - name: Install UMH
        run: |
          kubectl create ns united-manufacturing-hub
          helm install united-manufacturing-hub ./deployment/united-manufacturing-hub -f ./test/values.yaml -n united-manufacturing-hub --wait
          kubectl get po,svc -n united-manufacturing-hub
      - name: Run Data Flow Test Job
        run: |
          kubectl apply -f ./test/data-flow-test-job.yaml -n united-manufacturing-hub
          kubectl wait --for=condition=complete job/data-flow-test -n united-manufacturing-hub --timeout=-1s &
          completed=$!
          kubectl wait --for=condition=failed job/data-flow-test -n united-manufacturing-hub --timeout=-1s && exit 1 &
          failed=$!
          if wait $completed; then
              echo "Data Flow Test Job succeeded"
              kubectl logs job/data-flow-test -n united-manufacturing-hub
          elif wait $failed; then
              echo "Data Flow Test Job failed"
              kubectl logs job/data-flow-test -n united-manufacturing-hub
              exit 1
          fi