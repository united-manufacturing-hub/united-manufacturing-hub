---
{{if .Values._000_commonConfig.datasources.barcodereader.enabled}}

apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: {{include "united-manufacturing-hub.fullname" .}}-barcodereader
  labels:
    {{- include "united-manufacturing-hub.labels.barcodereader" . | nindent 4}}
spec:
  serviceName: {{include "united-manufacturing-hub.fullname" .}}-barcodereader
  replicas: 1
  selector:
    matchLabels:
      {{- include "united-manufacturing-hub.labels.barcodereader" . | nindent 6}}
  template:
    metadata:
      labels:
        {{- include "united-manufacturing-hub.labels.barcodereader" . | nindent 8}}
    spec:
      containers:
        - name: {{include "united-manufacturing-hub.fullname" .}}-barcodereader
          {{if .Values.barcodereader.tag}}
          image: {{.Values.barcodereader.image.repository}}:{{.Values.barcodereader.tag}}
          {{- else}}
          image: {{.Values.barcodereader.image.repository}}:{{.Chart.AppVersion}}
          {{end}}
          imagePullPolicy: {{.Values.barcodereader.image.pullPolicy}}
          resources:
            limits:
              cpu: {{.Values.barcodereader.resources.limits.cpu}}
              memory: {{.Values.barcodereader.resources.limits.memory}}
            requests:
              cpu: {{.Values.barcodereader.resources.requests.cpu}}
              memory: {{.Values.barcodereader.resources.requests.memory}}
          securityContext:
            privileged: true
          volumeMounts:
            - name: {{include "united-manufacturing-hub.fullname" .}}-barcodereader-certificates
              mountPath: /SSL_certs
              readOnly: true
            - name: devs
              mountPath: /dev/
          env:
          - name: CUSTOM_USB_NAME
            value: {{.Values._000_commonConfig.datasources.barcodereader.customUSBName}}
          - name: MQTT_CLIENT_ID
            value: {{.Values._000_commonConfig.serialNumber}}-barcodereader
          - name: BROKER_URL
            value: {{.Values._000_commonConfig.datasources.barcodereader.brokerURL}}
          - name: BROKER_PORT
            value: {{.Values._000_commonConfig.datasources.barcodereader.brokerPort | quote}}
          - name: CUSTOMER_ID
            value: {{.Values._000_commonConfig.datasources.barcodereader.customerID}}
          - name: LOCATION
            value: {{.Values._000_commonConfig.datasources.barcodereader.location}}
          - name: MACHINE_ID
            value: {{.Values._000_commonConfig.datasources.barcodereader.machineID}}
          - name: KAFKA_USE_SSL
            value: {{.Values._000_commonConfig.infrastructure.kafka.useSSL | quote}}
          - name: KAFKA_SSL_KEY_PASSWORD
            value: {{.Values._000_commonConfig.certificates.barcodereader.sslKeyPassword | quote}}

      volumes:
        - name: devs
          hostPath:
            path: /dev/
        - name: {{include "united-manufacturing-hub.fullname" .}}-barcodereader-certificates
          secret:
            secretName: {{include "united-manufacturing-hub.fullname" .}}-barcodereader-secrets

{{end}}
