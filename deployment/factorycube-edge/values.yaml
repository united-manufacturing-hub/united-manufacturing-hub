# Please adjust the following lines

serialNumber: "" # usually the hostname
mqttBridgeURL: "" # e.g. mqtt.app.industrial-analytics.net:8883
mqttBridgeTopic: "ia" # /# will be automatically appended to the string specified here.

# Certficiates for MQTT Bridge
mqttBridgeCACert: |
  Please add certificate here
mqttBridgeCert: |
  Please add certificate here
mqttBridgePrivkey: |
  Please add certificate here

##### DO NOT CHANGE ANYTHING BELOW HERE (except when you know what you are doing) #####

serviceAccount:
  create: true

### mqttbridge ###

mqttbridge:
  enabled: true
  image: unitedmanufacturinghub/mqtt-bridge 
  storageRequest: 1Gi

### barcodereader ###

barcodereader:
  enabled: true
  image: unitedmanufacturinghub/barcodereader
  customUSBName: "Datalogic ADC, Inc. Handheld Barcode Scanner"
  brokerURL: "factorycube-edge-emqxedge-headless" # do not change, points to emqxedge i
  brokerPort: 1883 # do not change
  customerID: "raw"
  location: "barcodereader"
  machineID: "barcodereader"
  #
### sensorconnect ###

sensorconnect:
  enabled: true
  image: unitedmanufacturinghub/sensorconnect
  iprange: "ENTER_IP_RANGE" #e.g. 172.21.9.0/24
  brokerURL: "factorycube-edge-emqxedge-headless" # do not change, points to emqxedge i
  brokerPort: 1883 # do not change

### cameraconnect ###
# https://docs.umh.app/docs/developers/factorycube-edge/cameraconnect/
cameraconnect:
  enabled: false
  image: unitedmanufacturinghub/cameraconnect
  # tag: development
  brokerURL: "factorycube-edge-emqxedge-headless" # do not change, points to emqxedge i
  brokerPort: 1883 # do not change
  trigger: "MQTT" # trigger to activate image , supports "MQTT", "Continuous"
  acquisitionDelay: "0.0" # time to wait between trigger received and image acquired
  cycleTime: "4" # time between images
  cameraInterface: "GenICam" # camera interface, currenty only uses GenIcam
  imageWidth: "800" # in pixels
  imageHeight: "800" # in pixels
  imageChannels: "3" # colour chanels, typically 1 or 3 
  macAddress: "02-2625A-09849" # mac address of the camera
  exposureTime: "1000" # exposure time in [TBD]
  exposureAuto: "Off" # whether to use auto exposeure or not, supports "OFF" and "ON"
  pixelFormat: "Mono8" # pixel format of the CAMERA, typically one of [TBD]
  loggingLevel: "INFO" # " LOGGING Level o be used"

### nodered ###

nodered:
  enabled: true
  pluginInstallEnabled: true
  pluginInstallLines: |-
      npm list node-red-contrib-modbus || npm install node-red-contrib-modbus;
      npm list node-red-contrib-edge-trigger || npm install node-red-contrib-edge-trigger;
      npm list node-red-contrib-opcua || npm install node-red-contrib-opcua;
      npm list node-red-contrib-s7 || npm install node-red-contrib-s7;
      npm list node-red-contrib-opc-da || npm install node-red-contrib-opc-da;
      npm list node-red-contrib-opcda-client || npm install node-red-contrib-opcda-client;
  tag: 1.3.5
  port: 1880
  storageRequest: 1Gi
  timezone: Berlin/Europe
  flows: |-
        [{"id":"9d0bf5c6.2530b8","type":"subflow","name":"output_to_activity","info":"","category":"ia: nodes","in":[],"out":[],"env":[{"name":"max_duration","type":"num","value":"10","ui":{"icon":"font-awesome/fa-clock-o","label":{"en-US":"max_duration"},"type":"input","opts":{"types":["num"]}}},{"name":"customerID","type":"str","value":"samplecustomerID","ui":{"type":"input","opts":{"types":["str"]},"label":{}}},{"name":"location","type":"str","value":"samplelocation","ui":{"type":"input","opts":{"types":["str"]},"label":{}}},{"name":"AssetID","type":"str","value":"sampleAssetID","ui":{"type":"input","opts":{"types":["str"]},"label":{}}}],"color":"#D5F0FF","icon":"node-red/sort.svg"},{"id":"1a01904d.a305b","type":"json","z":"9d0bf5c6.2530b8","name":"","property":"payload","action":"","pretty":false,"x":250,"y":100,"wires":[["d5821e95.eb077"]]},{"id":"85638585.b5dfb8","type":"mqtt in","z":"9d0bf5c6.2530b8","name":"MQTT-IN: output","topic":"ia/+/+/+/count","qos":"2","datatype":"auto","broker":"5dff9791.d1b278","x":100,"y":100,"wires":[["1a01904d.a305b"]]},{"id":"d5821e95.eb077","type":"function","z":"9d0bf5c6.2530b8","name":"Check for exakt Topic","func":"var topic = \"ia/\"+env.get(\"customerID\")+\"/\"+env.get(\"location\")+\"/\"+env.get(\"AssetID\")+\"/count\"\nif (topic == msg.topic) {\n  msg.payload = msg.payload\n} else {\n  msg.payload = null;\n}\nreturn msg;","outputs":1,"noerr":0,"x":420,"y":100,"wires":[["dc440bb.3e238f8"]]},{"id":"dc440bb.3e238f8","type":"switch","z":"9d0bf5c6.2530b8","name":"","property":"payload","propertyType":"msg","rules":[{"t":"nnull"}],"checkall":"true","repair":false,"outputs":1,"x":590,"y":100,"wires":[["c52cba61.6b62d8"]]},{"id":"b9e10ec3.94988","type":"function","z":"9d0bf5c6.2530b8","name":"Format: activity ","func":"msg.payload = {\n\"measurement\": env.get(\"customerID\")+\"-\"+env.get(\"location\")+\"-\"+env.get(\"AssetID\") ,\n\"timestamp_ms\": Date.now(),\n\"activity\": msg.payload\n}\n\nmsg.topic = \"ia/\"+env.get(\"customerID\")+\"/\"+env.get(\"location\")+\"/\"+env.get(\"AssetID\")+\"/activity\"\nreturn msg;\n\n","outputs":1,"noerr":0,"x":1400,"y":100,"wires":[["55c7ebc4.703714"]]},{"id":"55c7ebc4.703714","type":"mqtt out","z":"9d0bf5c6.2530b8","name":"MQTT-OUT: Verarbeitete Daten","topic":"","qos":"2","retain":"","broker":"5dff9791.d1b278","x":1670,"y":100,"wires":[]},{"id":"a0736c99.0b8bc","type":"rbe","z":"9d0bf5c6.2530b8","name":"","func":"rbe","gap":"","start":"","inout":"out","property":"payload","x":1250,"y":100,"wires":[["b9e10ec3.94988"]]},{"id":"c52cba61.6b62d8","type":"function","z":"9d0bf5c6.2530b8","name":"","func":"flow.set(\"ts_last_output\", Date.now())\nreturn null;","outputs":1,"noerr":0,"x":720,"y":100,"wires":[[]]},{"id":"3f8212b6.7c6b8e","type":"function","z":"9d0bf5c6.2530b8","name":"","func":"if (flow.get(\"ts_last_output\")==undefined) {\n  flow.set(\"ts_last_output\", Date.now())\n  return null;\n} else if ((Date.now()-flow.get(\"ts_last_output\"))<env.get(\"max_duration\")*1000) {\n  msg.payload = true;\n} else {\n  msg.payload = false;\n}\nreturn msg;","outputs":1,"noerr":0,"x":1100,"y":100,"wires":[["a0736c99.0b8bc"]]},{"id":"1a8345c1.409d4a","type":"inject","z":"9d0bf5c6.2530b8","name":"","repeat":"0.25","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":930,"y":100,"wires":[["3f8212b6.7c6b8e"]]},{"id":"882af5a6.a58b28","type":"subflow","name":"state_logic","info":"","category":"ia: nodes","in":[],"out":[],"env":[{"name":"customerID","type":"str","value":"samplecustomerID","ui":{"type":"input","opts":{"types":["str"]},"label":{}}},{"name":"location","type":"str","value":"samplelocation","ui":{"type":"input","opts":{"types":["str"]},"label":{}}},{"name":"AssetID","type":"str","value":"sampleAssetID","ui":{"type":"input","opts":{"types":["str"]},"label":{}}}],"color":"#D5F0FF","icon":"node-red/status.svg"},{"id":"b3c8f72d.df9cb8","type":"function","z":"882af5a6.a58b28","name":"State logic","func":"msg.payload = msg.payload.detectedAnomaly\nreturn msg;","outputs":1,"noerr":0,"x":1310,"y":120,"wires":[["8515bd04.5e05b"]]},{"id":"39cac321.c87fbc","type":"function","z":"882af5a6.a58b28","name":"get currentactivity","func":"msg.payload.currentActivity = flow.get(\"currentActivity\")\nreturn msg;","outputs":1,"noerr":0,"x":830,"y":120,"wires":[["8f417e0a.f6dc9"]]},{"id":"8f417e0a.f6dc9","type":"switch","z":"882af5a6.a58b28","name":"Only when machine is not running","property":"payload.currentActivity","propertyType":"msg","rules":[{"t":"false"}],"checkall":"true","repair":false,"outputs":1,"x":1080,"y":120,"wires":[["b3c8f72d.df9cb8"]]},{"id":"e25eb0a9.c84f1","type":"function","z":"882af5a6.a58b28","name":"set currentactivity","func":"flow.set(\"currentActivity\",msg.payload.activity)\nreturn msg;","outputs":1,"noerr":0,"x":750,"y":40,"wires":[["a53182a9.61bec"]]},{"id":"13ec32fe.d3a99d","type":"function","z":"882af5a6.a58b28","name":"Format: state (Machine Not Running with reason)","func":"msg.payload = {\n\"measurement\": env.get(\"customerID\")+\"-\"+env.get(\"location\")+\"-\"+env.get(\"AssetID\") ,\n\"timestamp_ms\": Date.now(),\n\"state\": parseInt(msg.payload)\n}\nflow.set(\"currentState\",msg.payload.state)\nmsg.topic = \"ia/\"+env.get(\"customerID\")+\"/\"+env.get(\"location\")+\"/\"+env.get(\"AssetID\")+\"/state\"\nreturn msg;\n\n","outputs":1,"noerr":0,"x":1710,"y":120,"wires":[["dae1723d.6a99f"]]},{"id":"a53182a9.61bec","type":"switch","z":"882af5a6.a58b28","name":"","property":"payload.activity","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":910,"y":40,"wires":[["1a46ed5a.1bc5a3"],["4b651e29.d8987"]]},{"id":"1a46ed5a.1bc5a3","type":"function","z":"882af5a6.a58b28","name":"Format: state (Machine running)","func":"msg.payload = {\n\"measurement\": env.get(\"customerID\")+\"-\"+env.get(\"location\")+\"-\"+env.get(\"AssetID\") ,\n\"timestamp_ms\": Date.now(),\n\"state\": 0\n}\nflow.set(\"currentState\",msg.payload.state)\nmsg.topic = \"ia/\"+env.get(\"customerID\")+\"/\"+env.get(\"location\")+\"/\"+env.get(\"AssetID\")+\"/state\"\nreturn msg;\n\n","outputs":1,"noerr":0,"x":1110,"y":40,"wires":[["dae1723d.6a99f"]]},{"id":"de0540c3.06dbd","type":"function","z":"882af5a6.a58b28","name":"Format: state (Machine not running no reason specified)","func":"msg.payload = {\n\"measurement\": env.get(\"customerID\")+\"-\"+env.get(\"location\")+\"-\"+env.get(\"AssetID\") ,\n\"timestamp_ms\": Date.now(),\n\"state\": 40000\n}\nflow.set(\"currentState\",msg.payload.state)\nmsg.topic = \"ia/\"+env.get(\"customerID\")+\"/\"+env.get(\"location\")+\"/\"+env.get(\"AssetID\")+\"/state\"\nreturn msg;\n\n","outputs":1,"noerr":0,"x":1490,"y":80,"wires":[["dae1723d.6a99f"]]},{"id":"dae1723d.6a99f","type":"mqtt out","z":"882af5a6.a58b28","name":"MQTT-OUT: Verarbeitete Daten","topic":"","qos":"2","retain":"","broker":"5dff9791.d1b278","x":2090,"y":80,"wires":[]},{"id":"8515bd04.5e05b","type":"switch","z":"882af5a6.a58b28","name":"","property":"payload","propertyType":"msg","rules":[{"t":"nnull"}],"checkall":"true","repair":false,"outputs":1,"x":1450,"y":120,"wires":[["13ec32fe.d3a99d"]]},{"id":"4b651e29.d8987","type":"function","z":"882af5a6.a58b28","name":"Was last state == machine running?","func":"if (flow.get(\"currentState\")==0) {\n  return msg;\n} else {\n  return null;\n}\n\n\n","outputs":1,"noerr":0,"x":1120,"y":80,"wires":[["de0540c3.06dbd"]]},{"id":"998214b0.4c1f38","type":"json","z":"882af5a6.a58b28","name":"","property":"payload","action":"","pretty":false,"x":250,"y":40,"wires":[["c14538f4.87cec8"]]},{"id":"22e3fbe0.e64c64","type":"mqtt in","z":"882af5a6.a58b28","name":"MQTT-IN: activity","topic":"ia/+/+/+/activity","qos":"2","datatype":"auto","broker":"5dff9791.d1b278","x":100,"y":40,"wires":[["998214b0.4c1f38"]]},{"id":"c14538f4.87cec8","type":"function","z":"882af5a6.a58b28","name":"Check for exakt Topic","func":"var topic = \"ia/\"+env.get(\"customerID\")+\"/\"+env.get(\"location\")+\"/\"+env.get(\"AssetID\")+\"/activity\"\nif (topic == msg.topic) {\n  msg.payload = msg.payload\n} else {\n  msg.payload = null;\n}\nreturn msg;","outputs":1,"noerr":0,"x":420,"y":40,"wires":[["e6293a0b.38e8b8"]]},{"id":"e6293a0b.38e8b8","type":"switch","z":"882af5a6.a58b28","name":"","property":"payload","propertyType":"msg","rules":[{"t":"nnull"}],"checkall":"true","repair":false,"outputs":1,"x":590,"y":40,"wires":[["e25eb0a9.c84f1"]]},{"id":"5ae068fb.be12a8","type":"mqtt in","z":"882af5a6.a58b28","name":"MQTT-IN: detectedAnomaly","topic":"ia/+/+/+/detectedAnomaly","qos":"2","datatype":"auto","broker":"5dff9791.d1b278","x":140,"y":120,"wires":[["8e9ed065.211af"]]},{"id":"8e9ed065.211af","type":"json","z":"882af5a6.a58b28","name":"","property":"payload","action":"","pretty":false,"x":330,"y":120,"wires":[["4a120d3d.8fad64"]]},{"id":"4a120d3d.8fad64","type":"function","z":"882af5a6.a58b28","name":"Check for exakt Topic","func":"var topic = \"ia/\"+env.get(\"customerID\")+\"/\"+env.get(\"location\")+\"/\"+env.get(\"AssetID\")+\"/detectedAnomaly\"\nif (topic == msg.topic) {\n  msg.payload = msg.payload\n} else {\n  msg.payload = null;\n}\nreturn msg;","outputs":1,"noerr":0,"x":500,"y":120,"wires":[["a82cfed9.9856a"]]},{"id":"a82cfed9.9856a","type":"switch","z":"882af5a6.a58b28","name":"","property":"payload","propertyType":"msg","rules":[{"t":"nnull"}],"checkall":"true","repair":false,"outputs":1,"x":670,"y":120,"wires":[["39cac321.c87fbc"]]},{"id":"ae592577.420618","type":"subflow","name":"processvalue","info":"","category":"","in":[{"x":60,"y":60,"wires":[{"id":"d996e872.8c0c88"}]}],"out":[],"env":[{"name":"namePV","type":"str","value":"yourProcessValueName","ui":{"icon":"font-awesome/fa-text-width","type":"input","opts":{"types":["str"]},"label":{}}},{"name":"customerID","type":"str","value":"samplecustomerID","ui":{"type":"input","opts":{"types":["str"]},"label":{}}},{"name":"location","type":"str","value":"samplelocation","ui":{"type":"input","opts":{"types":["str"]},"label":{}}},{"name":"AssetID","type":"str","value":"sampleAssetID","ui":{"type":"input","opts":{"types":["str"]},"label":{}}}],"color":"#D5F0FF","icon":"font-awesome/fa-area-chart"},{"id":"4888b756.23e248","type":"mqtt out","z":"ae592577.420618","name":"MQTT-OUT: Verarbeitete Daten","topic":"","qos":"1","retain":"","broker":"5dff9791.d1b278","x":770,"y":60,"wires":[]},{"id":"d996e872.8c0c88","type":"function","z":"ae592577.420618","name":"Format: processValue","func":"var namePV = env.get(\"namePV\")\nvar tempJSON = {\n\"measurement\": env.get(\"customerID\")+\"-\"+env.get(\"location\")+\"-\"+env.get(\"AssetID\") ,\n\"timestamp_ms\": Date.now(),\n}\ntempJSON[namePV]=msg.payload;\nmsg.payload= tempJSON;\nmsg.topic = \"ia/\"+env.get(\"customerID\")+\"/\"+env.get(\"location\")+\"/\"+env.get(\"AssetID\")+\"/processValue\"\nreturn msg;\n\n","outputs":1,"noerr":0,"x":480,"y":60,"wires":[["4888b756.23e248"]]},{"id":"fc9d8f9c.14845","type":"subflow","name":"count","info":"","category":"","in":[{"x":140,"y":120,"wires":[{"id":"a85c6ef3.fcf27"}]}],"out":[],"env":[{"name":"customerID","type":"str","value":"samplecustomerID","ui":{"type":"input","opts":{"types":["str"]},"label":{}}},{"name":"location","type":"str","value":"samplelocation","ui":{"type":"input","opts":{"types":["str"]},"label":{}}},{"name":"AssetID","type":"str","value":"sampleAssetID","ui":{"type":"input","opts":{"types":["str"]},"label":{}}}],"color":"#D5F0FF","icon":"node-red-dashboard/ui_chart.png"},{"id":"a85c6ef3.fcf27","type":"function","z":"fc9d8f9c.14845","name":"Format: count","func":"msg.payload = {\n\"measurement\": env.get(\"customerID\")+\"-\"+env.get(\"location\")+\"-\"+env.get(\"AssetID\") ,\n\"timestamp_ms\": Date.now(),\n\"count\": msg.payload\n}\nmsg.topic = \"ia/\"+env.get(\"customerID\")+\"/\"+env.get(\"location\")+\"/\"+env.get(\"AssetID\")+\"/count\"\nreturn msg;\n\n","outputs":1,"noerr":0,"x":300,"y":120,"wires":[["767ff1ad.008cd"]]},{"id":"767ff1ad.008cd","type":"mqtt out","z":"fc9d8f9c.14845","name":"MQTT-OUT: Verarbeitete Daten","topic":"","qos":"2","retain":"","broker":"5dff9791.d1b278","x":550,"y":120,"wires":[]},{"id":"b60b06bc.cdb4c8","type":"subflow","name":"detectedAnomaly","info":"","category":"","in":[{"x":40,"y":80,"wires":[{"id":"c9fa6d5b.84b01"}]}],"out":[],"env":[{"name":"customerID","type":"str","value":"samplecustomerID","ui":{"type":"input","opts":{"types":["str"]},"label":{}}},{"name":"location","type":"str","value":"samplelocation","ui":{"type":"input","opts":{"types":["str"]},"label":{}}},{"name":"AssetID","type":"str","value":"sampleAssetID","ui":{"type":"input","opts":{"types":["str"]},"label":{}}}],"color":"#D5F0FF","icon":"node-red/alert.svg"},{"id":"1222fb98.eff494","type":"mqtt out","z":"b60b06bc.cdb4c8","name":"MQTT-OUT: Verarbeitete Daten","topic":"","qos":"","retain":"","broker":"5dff9791.d1b278","x":470,"y":80,"wires":[]},{"id":"c9fa6d5b.84b01","type":"function","z":"b60b06bc.cdb4c8","name":"Format: detectedAnomaly","func":"msg.payload = {\n\"measurement\": env.get(\"customerID\")+\"-\"+env.get(\"location\")+\"-\"+env.get(\"AssetID\") ,\n\"timestamp_ms\": Date.now(),\n\"detectedAnomaly\": msg.payload\n}\nmsg.topic = \"ia/\"+env.get(\"customerID\")+\"/\"+env.get(\"location\")+\"/\"+env.get(\"AssetID\")+\"/detectedAnomaly\"\nreturn msg;\n\n","outputs":1,"noerr":0,"x":190,"y":80,"wires":[["1222fb98.eff494"]]},{"id":"b77cb6f5.685178","type":"subflow","name":"activity","info":"","category":"","in":[{"x":60,"y":80,"wires":[{"id":"99402063.da8ae"}]}],"out":[],"env":[{"name":"customerID","type":"str","value":"samplecustomerID","ui":{"type":"input","opts":{"types":["str"]},"label":{}}},{"name":"location","type":"str","value":"samplelocation","ui":{"type":"input","opts":{"types":["str"]},"label":{}}},{"name":"AssetID","type":"str","value":"sampleAssetID","ui":{"type":"input","opts":{"types":["str"]},"label":{}}}],"color":"#D5F0FF","icon":"node-red/serial.svg"},{"id":"6e72af6b.e6363","type":"function","z":"b77cb6f5.685178","name":"Format: Activity","func":"msg.payload = {\n\"measurement\": env.get(\"customerID\")+\"-\"+env.get(\"location\")+\"-\"+env.get(\"AssetID\") ,\n\"timestamp_ms\": Date.now(),\n\"activity\": msg.payload\n}\nmsg.topic = \"ia/\"+env.get(\"customerID\")+\"/\"+env.get(\"location\")+\"/\"+env.get(\"AssetID\")+\"/activity\"\nreturn msg;\n\n","outputs":1,"noerr":0,"x":340,"y":80,"wires":[["c68b3ec2.40d31"]]},{"id":"c68b3ec2.40d31","type":"mqtt out","z":"b77cb6f5.685178","name":"MQTT-OUT: Verarbeitete Daten","topic":"","qos":"2","retain":"","broker":"5dff9791.d1b278","x":570,"y":80,"wires":[]},{"id":"99402063.da8ae","type":"rbe","z":"b77cb6f5.685178","name":"","func":"rbe","gap":"","start":"","inout":"out","property":"payload","x":190,"y":80,"wires":[["6e72af6b.e6363"]]},{"id":"5dff9791.d1b278","type":"mqtt-broker","name":"","broker":"factorycube-edge-emqxedge-headless","port":"1883","clientid":"","usetls":false,"compatmode":false,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthPayload":"","closeTopic":"","closeQos":"0","closePayload":"","willTopic":"","willQos":"0","willPayload":""},{"id":"45f7c4f7.dff1cc","type":"tab","label":"Default Flow","disabled":false,"info":""},{"id":"62375092.d1012","type":"group","z":"45f7c4f7.dff1cc","name":"Sample Data","style":{"stroke":"none","fill":"#DAECF0","label":true,"color":"#000000","label-position":"n"},"nodes":["6e3f046.47cecfc","f8283b61.08d9e8","5b0afc76.d39564","20f4ef35.92e22","5649a4d0.ce43ec"],"x":34,"y":19,"w":192,"h":242},{"id":"7cef6b1d.d23a54","type":"group","z":"45f7c4f7.dff1cc","name":"United Manufacturing Hub Nodered-connectors","style":{"fill":"#2D393D","fill-opacity":"0.66","label":true,"color":"#ffffff","label-position":"n","stroke":"none"},"nodes":["96c50010.c50af","ae8cdaa6.a56a68","c8d8afe1.59fa","246a1685.58379a","7bb0392e.8a3bf8","b34237d9.7d2cc8"],"x":454,"y":19,"w":301,"h":282},{"id":"ba92812b.1beda","type":"group","z":"45f7c4f7.dff1cc","name":"Selection of standard interfaces","style":{"stroke":"none","fill":"#DAECF0","label":true,"label-position":"n","color":"#000000"},"nodes":["c3372d57.50822","f75ad281.e4769","bf268a03.906548","37c52f75.d6a81","a8e1a854.89e108","cdd3a9a3.ceed18","28b0d095.a6f2e","15717681.474919","f5d9d48f.ad1028","28ac3b5b.0c6e64"],"x":34,"y":299,"w":412,"h":402},{"id":"96c50010.c50af","type":"subflow:b77cb6f5.685178","z":"45f7c4f7.dff1cc","g":"7cef6b1d.d23a54","name":"","env":[{"name":"customerID","value":"factoryinsight","type":"str"},{"name":"location","value":"test","type":"str"},{"name":"AssetID","value":"test","type":"str"}],"x":530,"y":140,"wires":[]},{"id":"ae8cdaa6.a56a68","type":"subflow:b60b06bc.cdb4c8","z":"45f7c4f7.dff1cc","g":"7cef6b1d.d23a54","name":"","env":[{"name":"customerID","value":"factoryinsight","type":"str"},{"name":"location","value":"test","type":"str"},{"name":"AssetID","value":"test","type":"str"}],"x":570,"y":220,"wires":[]},{"id":"c8d8afe1.59fa","type":"subflow:fc9d8f9c.14845","z":"45f7c4f7.dff1cc","g":"7cef6b1d.d23a54","name":"","env":[{"name":"customerID","value":"factoryinsight","type":"str"},{"name":"location","value":"test","type":"str"},{"name":"AssetID","value":"test","type":"str"}],"x":530,"y":180,"wires":[]},{"id":"246a1685.58379a","type":"subflow:ae592577.420618","z":"45f7c4f7.dff1cc","g":"7cef6b1d.d23a54","name":"","env":[{"name":"customerID","value":"factoryinsight","type":"str"},{"name":"location","value":"test","type":"str"},{"name":"AssetID","value":"test","type":"str"}],"x":550,"y":260,"wires":[]},{"id":"7bb0392e.8a3bf8","type":"subflow:882af5a6.a58b28","z":"45f7c4f7.dff1cc","g":"7cef6b1d.d23a54","name":"","env":[{"name":"customerID","value":"factoryinsight","type":"str"},{"name":"location","value":"test","type":"str"},{"name":"AssetID","value":"test","type":"str"},{"name":"customer_states","value":"","type":"str"}],"x":540,"y":100,"wires":[]},{"id":"b34237d9.7d2cc8","type":"subflow:9d0bf5c6.2530b8","z":"45f7c4f7.dff1cc","g":"7cef6b1d.d23a54","name":"","env":[{"name":"customerID","value":"factoryinsight","type":"str"},{"name":"location","value":"test","type":"str"},{"name":"AssetID","value":"test","type":"str"}],"x":560,"y":60,"wires":[]},{"id":"6e3f046.47cecfc","type":"inject","z":"45f7c4f7.dff1cc","g":"62375092.d1012","name":"True","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"5","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"true","payloadType":"bool","x":130,"y":60,"wires":[["96c50010.c50af"]]},{"id":"f8283b61.08d9e8","type":"inject","z":"45f7c4f7.dff1cc","g":"62375092.d1012","name":"False","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"8","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"false","payloadType":"bool","x":130,"y":100,"wires":[["96c50010.c50af"]]},{"id":"5b0afc76.d39564","type":"inject","z":"45f7c4f7.dff1cc","g":"62375092.d1012","name":"Number","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"3","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"60000","payloadType":"num","x":140,"y":180,"wires":[["ae8cdaa6.a56a68"]]},{"id":"20f4ef35.92e22","type":"inject","z":"45f7c4f7.dff1cc","g":"62375092.d1012","name":"True","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"15","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"1","payloadType":"num","x":130,"y":140,"wires":[["c8d8afe1.59fa"]]},{"id":"5649a4d0.ce43ec","type":"inject","z":"45f7c4f7.dff1cc","g":"62375092.d1012","name":"True","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"15","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":130,"y":220,"wires":[["246a1685.58379a"]]},{"id":"c3372d57.50822","type":"mqtt in","z":"45f7c4f7.dff1cc","d":true,"g":"ba92812b.1beda","name":"","topic":"ia/#","qos":"2","datatype":"auto","broker":"5dff9791.d1b278","x":130,"y":340,"wires":[[]]},{"id":"f75ad281.e4769","type":"opcda-write","z":"45f7c4f7.dff1cc","d":true,"g":"ba92812b.1beda","server":"","name":"","x":150,"y":420,"wires":[[]]},{"id":"bf268a03.906548","type":"opcda-read","z":"45f7c4f7.dff1cc","d":true,"g":"ba92812b.1beda","server":"","name":"","updaterate":1000,"cache":false,"datachange":false,"groupitems":[],"x":150,"y":380,"wires":[[]]},{"id":"37c52f75.d6a81","type":"modbus-read","z":"45f7c4f7.dff1cc","d":true,"g":"ba92812b.1beda","name":"","topic":"","showStatusActivities":false,"logIOActivities":false,"showErrors":false,"unitid":"","dataType":"","adr":"","quantity":"","rate":"","rateUnit":"","delayOnStart":false,"startDelayTime":"","server":"","useIOFile":false,"ioFile":"","useIOForPayload":false,"emptyMsgOnFail":false,"x":150,"y":500,"wires":[[],[]]},{"id":"a8e1a854.89e108","type":"s7 in","z":"45f7c4f7.dff1cc","d":true,"g":"ba92812b.1beda","endpoint":"","mode":"single","variable":"","diff":true,"name":"","x":130,"y":540,"wires":[[]]},{"id":"cdd3a9a3.ceed18","type":"s7 out","z":"45f7c4f7.dff1cc","d":true,"g":"ba92812b.1beda","endpoint":"","variable":"","name":"","x":130,"y":580,"wires":[]},{"id":"28b0d095.a6f2e","type":"http request","z":"45f7c4f7.dff1cc","d":true,"g":"ba92812b.1beda","name":"REST","method":"GET","ret":"txt","paytoqs":"ignore","url":"","tls":"","persist":false,"proxy":"","authType":"","x":130,"y":620,"wires":[[]]},{"id":"15717681.474919","type":"tcp request","z":"45f7c4f7.dff1cc","d":true,"g":"ba92812b.1beda","server":"","port":"","out":"time","splitc":"0","name":"TCP-IP","x":140,"y":660,"wires":[[]]},{"id":"f5d9d48f.ad1028","type":"OpcUa-Browser","z":"45f7c4f7.dff1cc","d":true,"g":"ba92812b.1beda","endpoint":"","item":"","datatype":"","topic":"","items":[],"name":"","x":330,"y":460,"wires":[[]]},{"id":"28ac3b5b.0c6e64","type":"inject","z":"45f7c4f7.dff1cc","d":true,"g":"ba92812b.1beda","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"1","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":150,"y":460,"wires":[["f5d9d48f.ad1028"]]}]

  settings: |-  
    module.exports = {
        // the tcp port that the Node-RED web server is listening on
        uiPort: process.env.PORT || 1880,
        // By default, the Node-RED UI accepts connections on all IPv4 interfaces.
        // To listen on all IPv6 addresses, set uiHost to "::",
        // The following property can be used to listen on a specific interface. For
        // example, the following would only allow connections from the local machine.
        //uiHost: "127.0.0.1",
        // Retry time in milliseconds for MQTT connections
        mqttReconnectTime: 15000,
        // Retry time in milliseconds for Serial port connections
        serialReconnectTime: 15000,
        // Retry time in milliseconds for TCP socket connections
        //socketReconnectTime: 10000,
        // Timeout in milliseconds for TCP server socket connections
        //  defaults to no timeout
        //socketTimeout: 120000,
        // Maximum number of messages to wait in queue while attempting to connect to TCP socket
        //  defaults to 1000
        //tcpMsgQueueSize: 2000,
        // Timeout in milliseconds for HTTP request connections
        //  defaults to 120 seconds
        //httpRequestTimeout: 120000,
        // The maximum length, in characters, of any message sent to the debug sidebar tab
        debugMaxLength: 1000,
        // The maximum number of messages nodes will buffer internally as part of their
        // operation. This applies across a range of nodes that operate on message sequences.
        //  defaults to no limit. A value of 0 also means no limit is applied.
        //nodeMessageBufferMaxLength: 0,
        // To disable the option for using local files for storing keys and certificates in the TLS configuration
        //  node, set this to true
        //tlsConfigDisableLocalFiles: true,
        // Colourise the console output of the debug node
        //debugUseColors: true,
        // The file containing the flows. If not set, it defaults to flows_<hostname>.json
        //flowFile: 'flows.json',
        // To enabled pretty-printing of the flow within the flow file, set the following
        //  property to true:
        //flowFilePretty: true,
        // By default, credentials are encrypted in storage using a generated key. To
        // specify your own secret, set the following property.
        // If you want to disable encryption of credentials, set this property to false.
        // Note: once you set this property, do not change it - doing so will prevent
        // node-red from being able to decrypt your existing credentials and they will be
        // lost.
        //credentialSecret: "a-secret-key",
        // By default, all user data is stored in a directory called `.node-red` under
        // the user's home directory. To use a different location, the following
        // property can be used
        //userDir: '/home/nol/.node-red/',
        // Node-RED scans the `nodes` directory in the userDir to find local node files.
        // The following property can be used to specify an additional directory to scan.
        //nodesDir: '/home/nol/.node-red/nodes',
        // By default, the Node-RED UI is available at http://localhost:1880/
        // The following property can be used to specify a different root path.
        // If set to false, this is disabled.
        //httpAdminRoot: '/admin',
        // Some nodes, such as HTTP In, can be used to listen for incoming http requests.
        // By default, these are served relative to '/'. The following property
        // can be used to specifiy a different root path. If set to false, this is
        // disabled.
        //httpNodeRoot: '/red-nodes',
        // The following property can be used in place of 'httpAdminRoot' and 'httpNodeRoot',
        // to apply the same root to both parts.
        httpRoot: '/nodered',
        // When httpAdminRoot is used to move the UI to a different root path, the
        // following property can be used to identify a directory of static content
        // that should be served at http://localhost:1880/.
        //httpStatic: '/home/nol/node-red-static/',
        // The maximum size of HTTP request that will be accepted by the runtime api.
        // Default: 5mb
        //apiMaxLength: '5mb',
        // If you installed the optional node-red-dashboard you can set it's path
        // relative to httpRoot
        ui: { path: "ui" },
        // Securing Node-RED
        // -----------------
        // To password protect the Node-RED editor and admin API, the following
        // property can be used. See http://nodered.org/docs/security.html for details.
        //adminAuth: {},
        // To password protect the node-defined HTTP endpoints (httpNodeRoot), or
        // the static content (httpStatic), the following properties can be used.
        // The pass field is a bcrypt hash of the password.
        // See http://nodered.org/docs/security.html#generating-the-password-hash
        //httpNodeAuth: {user:"user",pass:"$2a$08$zZWtXTja0fB1pzD4sHCMyOCMYz2Z6dNbM6tl8sJogENOMcxWV9DN."},
        //httpStaticAuth: {user:"user",pass:"$2a$08$zZWtXTja0fB1pzD4sHCMyOCMYz2Z6dNbM6tl8sJogENOMcxWV9DN."},
        // The following property can be used to enable HTTPS
        // See http://nodejs.org/api/https.html#https_https_createserver_options_requestlistener
        // for details on its contents.
        // This property can be either an object, containing both a (private) key and a (public) certificate,
        // or a function that returns such an object:
        //// https object:
        //https: {
        //  key: require("fs").readFileSync('privkey.pem'),
        //  cert: require("fs").readFileSync('cert.pem')
        //},
        ////https function:
        // https: function() {
        //     // This function should return the options object, or a Promise
        //     // that resolves to the options object
        //     return {
        //         key: require("fs").readFileSync('privkey.pem'),
        //         cert: require("fs").readFileSync('cert.pem')
        //     }
        // },
        // The following property can be used to refresh the https settings at a
        // regular time interval in hours.
        // This requires:
        //   - the `https` setting to be a function that can be called to get
        //     the refreshed settings.
        //   - Node.js 11 or later.
        //httpsRefreshInterval : 12,
        // The following property can be used to cause insecure HTTP connections to
        // be redirected to HTTPS.
        //requireHttps: true,
        // The following property can be used to disable the editor. The admin API
        // is not affected by this option. To disable both the editor and the admin
        // API, use either the httpRoot or httpAdminRoot properties
        //disableEditor: false,
        // The following property can be used to configure cross-origin resource sharing
        // in the HTTP nodes.
        // See https://github.com/troygoode/node-cors#configuration-options for
        // details on its contents. The following is a basic permissive set of options:
        //httpNodeCors: {
        //    origin: "*",
        //    methods: "GET,PUT,POST,DELETE"
        //},
        // If you need to set an http proxy please set an environment variable
        // called http_proxy (or HTTP_PROXY) outside of Node-RED in the operating system.
        // For example - http_proxy=http://myproxy.com:8080
        // (Setting it here will have no effect)
        // You may also specify no_proxy (or NO_PROXY) to supply a comma separated
        // list of domains to not proxy, eg - no_proxy=.acme.co,.acme.co.uk
        // The following property can be used to add a custom middleware function
        // in front of all http in nodes. This allows custom authentication to be
        // applied to all http in nodes, or any other sort of common request processing.
        //httpNodeMiddleware: function(req,res,next) {
        //    // Handle/reject the request, or pass it on to the http in node by calling next();
        //    // Optionally skip our rawBodyParser by setting this to true;
        //    //req.skipRawBodyParser = true;
        //    next();
        //},
        // The following property can be used to add a custom middleware function
        // in front of all admin http routes. For example, to set custom http
        // headers
        // httpAdminMiddleware: function(req,res,next) {
        //    // Set the X-Frame-Options header to limit where the editor
        //    // can be embedded
        //    //res.set('X-Frame-Options', 'sameorigin');
        //    next();
        // },
        // The following property can be used to pass custom options to the Express.js
        // server used by Node-RED. For a full list of available options, refer
        // to http://expressjs.com/en/api.html#app.settings.table
        //httpServerOptions: { },
        // The following property can be used to verify websocket connection attempts.
        // This allows, for example, the HTTP request headers to be checked to ensure
        // they include valid authentication information.
        //webSocketNodeVerifyClient: function(info) {
        //    // 'info' has three properties:
        //    //   - origin : the value in the Origin header
        //    //   - req : the HTTP request
        //    //   - secure : true if req.connection.authorized or req.connection.encrypted is set
        //    //
        //    // The function should return true if the connection should be accepted, false otherwise.
        //    //
        //    // Alternatively, if this function is defined to accept a second argument, callback,
        //    // it can be used to verify the client asynchronously.
        //    // The callback takes three arguments:
        //    //   - result : boolean, whether to accept the connection or not
        //    //   - code : if result is false, the HTTP error status to return
        //    //   - reason: if result is false, the HTTP reason string to return
        //},
        // The following property can be used to seed Global Context with predefined
        // values. This allows extra node modules to be made available with the
        // Function node.
        // For example,
        //    functionGlobalContext: { os:require('os') }
        // can be accessed in a function block as:
        //    global.get("os")
        functionGlobalContext: {
            // os:require('os'),
            // jfive:require("johnny-five"),
            // j5board:require("johnny-five").Board({repl:false})
        },
        // `global.keys()` returns a list of all properties set in global context.
        // This allows them to be displayed in the Context Sidebar within the editor.
        // In some circumstances it is not desirable to expose them to the editor. The
        // following property can be used to hide any property set in `functionGlobalContext`
        // from being list by `global.keys()`.
        // By default, the property is set to false to avoid accidental exposure of
        // their values. Setting this to true will cause the keys to be listed.
        exportGlobalContextKeys: false,
        // Context Storage
        // The following property can be used to enable context storage. The configuration
        // provided here will enable file-based context that flushes to disk every 30 seconds.
        // Refer to the documentation for further options: https://nodered.org/docs/api/context/
        //
        //contextStorage: {
        //    default: {
        //        module:"localfilesystem"
        //    },
        //},
        // The following property can be used to order the categories in the editor
        // palette. If a node's category is not in the list, the category will get
        // added to the end of the palette.
        // If not set, the following default order is used:
        //paletteCategories: ['subflows', 'common', 'function', 'network', 'sequence', 'parser', 'storage'],
        // Configure the logging output
        logging: {
            // Only console logging is currently supported
            console: {
                // Level of logging to be recorded. Options are:
                // fatal - only those errors which make the application unusable should be recorded
                // error - record errors which are deemed fatal for a particular request + fatal errors
                // warn - record problems which are non fatal + errors + fatal errors
                // info - record information about the general running of the application + warn + error + fatal errors
                // debug - record information which is more verbose than info + info + warn + error + fatal errors
                // trace - record very detailed logging + debug + info + warn + error + fatal errors
                // off - turn off all logging (doesn't affect metrics or audit)
                level: "info",
                // Whether or not to include metric events in the log output
                metrics: false,
                // Whether or not to include audit events in the log output
                audit: false
            }
        },
        // Customising the editor
        editorTheme: {
            projects: {
                // To enable the Projects feature, set this value to true
                enabled: false
            }
        }
    }

### emqxedge ###
emqxedge:

  ## It is recommended to have odd number of nodes in a cluster, otherwise the emqx cluster cannot be automatically healed in case of net-split.
  replicaCount: 1 
  image:
    repository: emqx/emqx-edge
    tag: 4.2.7
    pullPolicy: IfNotPresent

  persistence:
    enabled: true
    size: 1Gi
    ## If defined, volume.beta.kubernetes.io/storage-class: <storageClass>
    ## Default: volume.alpha.kubernetes.io/storage-class: default
    # storageClass: "-"
    accessMode: ReadWriteOnce
    ## Existing PersistentVolumeClaims
    ## The value is evaluated as a template
    ## So, for example, the name can depend on .Release or .Chart
    # existingClaim: ""

  resources: {}
    # limits:
    #   cpu: 500m
    #   memory: 512Mi
    # requests:
    #   cpu: 500m
    #   memory: 512Mi

  # Containers that run before the creation of EMQX containers. They can contain utilities or setup scripts.
  initContainers: {}
    # - name: mysql-probe
    #   image: alpine
    #   command: ["sh", "-c", "for i in $(seq 1 300); do nc -zvw1 mysql 3306 && exit 0 || sleep 3; done; exit 1"]

  ## EMQX configuration item, see the documentation (https://github.com/emqx/emqx-docker#emq-x-configuration)
  emqxConfig:
    EMQX_CLUSTER__K8S__APISERVER: "https://kubernetes.default.svc:443"
    ## The address type is used to extract host from k8s service.
    ## Value: ip | dns | hostname
    ## Noteï¼šHostname is only supported after v4.0-rc.2
    EMQX_CLUSTER__K8S__ADDRESS_TYPE: "hostname"
    EMQX_CLUSTER__K8S__SUFFIX: "svc.cluster.local"
    EMQX_LOADED_PLUGINS: "emqx_recon,emqx_retainer,emqx_management,emqx_dashboard,emqx_bridge_mqtt"
    ## if EMQX_CLUSTER__K8S__ADDRESS_TYPE eq dns
    # EMQX_CLUSTER__K8S__SUFFIX: "pod.cluster.local"
    emqxAclConfig: >
      {allow, all}.

  service:
    ## Service type
    ##
    type: LoadBalancer
    ## Port for MQTT
    ##
    mqtt: 1883
    ## Port for MQTT(SSL) 
    ##
    mqttssl: 8883
    ## Port for mgmt API
    ##
    mgmt: 8081
    ## Port for WebSocket/HTTP
    ##
    ws: 8083
    ## Port for WSS/HTTPS
    ##
    wss: 8084
    ## Port for dashboard
    ##
    dashboard: 18083
    ## Specify the nodePort(s) value for the LoadBalancer and NodePort service types.
    ## ref: https://kubernetes.io/docs/concepts/services-networking/service/#type-nodeport
    ##
    nodePorts:
      mqtt:
      mqttssl:
      mgmt:
      ws:
      wss:
      dashboard:
    ## Set the LoadBalancer service type to internal only.
    ## ref: https://kubernetes.io/docs/concepts/services-networking/service/#internal-load-balancer
    ##
    # loadBalancerIP:
    ## Load Balancer sources
    ## ref: https://kubernetes.io/docs/tasks/access-application-cluster/configure-cloud-provider-firewall/#restrict-access-for-loadbalancer-service
    ## Example:
    ## loadBalancerSourceRanges:
    ## - 10.10.10.0/24
    ##
    loadBalancerSourceRanges: []
    ## Provide any additional annotations which may be required. Evaluated as a template
    ##
    annotations: {}

  nodeSelector: {}

  tolerations: []

  affinity: {}

  ingress:
    ## ingress for EMQX Dashboard
    dashboard:
      enabled: false
      annotations: {}
        # kubernetes.io/ingress.class: nginx
        # kubernetes.io/tls-acme: "true"
      path: /
      hosts:
      - dashboard.emqx.local
      tls: []

    ## ingress for EMQX Mgmt API
    mgmt:
      enabled: false
      annotations: {}
        # kubernetes.io/ingress.class: nginx
        # kubernetes.io/tls-acme: "true"
      path: /
      hosts:
      - api.emqx.local
      tls: []
